name: PR è‡ªåŠ¨åˆ†æå¹¶æ›´æ–° Changelog

on:
  pull_request:
    types: [closed]
    branches: [main]

jobs:
  analyze-and-update:
    name: åˆ†æ PR å¹¶æ›´æ–° CHANGELOG
    runs-on: ubuntu-latest
    if: github.event.pull_request.merged == true
    permissions:
      contents: write
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - name: æå– PR ä¿¡æ¯
        id: extract_pr_info
        run: |
          echo "PR æ ‡é¢˜: ${{ github.event.pull_request.title }}"
          echo "PR ç¼–å·: ${{ github.event.pull_request.number }}"
          echo "åˆå¹¶æ—¶é—´: $(date +'%Y-%m-%d')"
          
          # æå– PR æ ‡ç­¾
          LABELS="${{ join(github.event.pull_request.labels.*.name, ',') }}"
          echo "PR æ ‡ç­¾: $LABELS"
          echo "labels=$LABELS" >> $GITHUB_OUTPUT
      
      - name: åˆ†æ PR ç±»å‹
        id: analyze_type
        run: |
          TITLE="${{ github.event.pull_request.title }}"
          LABELS="${{ steps.extract_pr_info.outputs.labels }}"
          
          # æ ¹æ® PR æ ‡ç­¾ç¡®å®šç±»å‹
          if echo "$LABELS" | grep -q "enhancement"; then
            CHANGE_TYPE="æ–°å¢"
          elif echo "$LABELS" | grep -q "bug"; then
            CHANGE_TYPE="ä¿®å¤"
          elif echo "$LABELS" | grep -q "documentation"; then
            CHANGE_TYPE="æ–‡æ¡£"
          elif echo "$LABELS" | grep -q "refactor"; then
            CHANGE_TYPE="é‡æ„"
          elif echo "$LABELS" | grep -q "performance"; then
            CHANGE_TYPE="ä¼˜åŒ–"
          else
            # æ ¹æ®æ ‡é¢˜å‰ç¼€åˆ¤æ–­
            if echo "$TITLE" | grep -qiE "^(feat|add|new|æ–°å¢|æ·»åŠ )"; then
              CHANGE_TYPE="æ–°å¢"
            elif echo "$TITLE" | grep -qiE "^(fix|bug|ä¿®å¤)"; then
              CHANGE_TYPE="ä¿®å¤"
            elif echo "$TITLE" | grep -qiE "^(doc|docs|readme|æ›´æ–°æ–‡æ¡£)"; then
              CHANGE_TYPE="æ–‡æ¡£"
            elif echo "$TITLE" | grep -qiE "^(refactor|é‡æ„)"; then
              CHANGE_TYPE="é‡æ„"
            elif echo "$TITLE" | grep -qiE "^(perf|performance|ä¼˜åŒ–)"; then
              CHANGE_TYPE="ä¼˜åŒ–"
            else
              CHANGE_TYPE="æ”¹è¿›"
            fi
          fi
          
          echo "change_type=$CHANGE_TYPE" >> $GITHUB_OUTPUT
          echo "å˜æ›´ç±»å‹: $CHANGE_TYPE"
      
      - name: æå–æäº¤ä¿¡æ¯
        id: extract_commits
        run: |
          COMMITS=$(git log --pretty=format:"%s" ${{ github.event.pull_request.base.sha }}..${{ github.event.pull_request.head.sha }})
          echo "commits<<EOF" >> $GITHUB_OUTPUT
          echo "$COMMITS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          echo "ç›¸å…³æäº¤:"
          echo "$COMMITS"
      
      - name: ç”Ÿæˆ Changelog æ¡ç›®
        id: generate_changelog
        run: |
          CHANGE_TYPE="${{ steps.analyze_type.outputs.change_type }}"
          TITLE="${{ github.event.pull_request.title }}"
          COMMITS="${{ steps.extract_commits.outputs.commits }}"
          PR_NUM="${{ github.event.pull_request.number }}"
          DATE=$(date +'%Y-%m-%d')
          
          # è¯»å–å½“å‰ç‰ˆæœ¬å·
          if [ -f main.py ]; then
            VERSION=$(grep -o "__version__ = \"[^\"]*\"" main.py | cut -d'"' -f2)
          else
            VERSION="æœªçŸ¥ç‰ˆæœ¬"
          fi
          
          # ç”Ÿæˆ Changelog å†…å®¹
          cat > changelog_entry.md << EOF
          ## [${VERSION}] - ${DATE}

          ### ${CHANGE_TYPE}
          - ${TITLE} (PR #${PR_NUM})
          
          ### ç›¸å…³æäº¤
          ${COMMITS}

          ---
          EOF
          
          echo "entry<<EOF" >> $GITHUB_OUTPUT
          cat changelog_entry.md >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          echo "ç”Ÿæˆçš„ Changelog æ¡ç›®:"
          cat changelog_entry.md
      
      - name: æ›´æ–° CHANGELOG.md
        run: |
          # å¤‡ä»½åŸæ–‡ä»¶
          cp CHANGELOG.md CHANGELOG.md.bak
          
          # æ’å…¥æ–°æ¡ç›®åˆ°æ–‡ä»¶å¼€å¤´ï¼ˆåœ¨æ ‡é¢˜ä¹‹åï¼‰
          awk "
            /^# æ›´æ–°æ—¥å¿—/ { print; print \"\"; system(\"cat ${{ steps.generate_changelog.outputs.entry }}\"); next }
            { print }
          " CHANGELOG.md.bak > CHANGELOG.md.new
          
          # æ›¿æ¢åŸæ–‡ä»¶
          mv CHANGELOG.md.new CHANGELOG.md
          
          # æ¸…ç†
          rm CHANGELOG.md.bak
          
          echo "å·²æ›´æ–° CHANGELOG.md"
          echo "---"
          head -n 20 CHANGELOG.md
      
      - name: æäº¤æ›´æ”¹
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add CHANGELOG.md
          git commit -m "docs: è‡ªåŠ¨æ›´æ–° CHANGELOG - PR #${{ github.event.pull_request.number }}"
          
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: å‘é€è¯„è®ºåˆ° PR
        uses: actions/github-script@v7
        with:
          script: |
            const changelog = `${{ steps.generate_changelog.outputs.entry }}`;
            github.rest.issues.createComment({
              issue_number: context.payload.pull_request.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `ğŸ“ **å·²è‡ªåŠ¨æ›´æ–° CHANGELOG.md**\n\n${changelog}\n\n---\n\nâœ… æ­¤æ¡ç›®å°†åœ¨ä¸‹æ¬¡ Release æ—¶åŒ…å«åœ¨å‘å¸ƒè¯´æ˜ä¸­ã€‚`
            })