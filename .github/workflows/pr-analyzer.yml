name: PR è‡ªåŠ¨åˆ†æå¹¶æ›´æ–° Changelog

on:
  pull_request:
    types: [closed]
    branches: [main]

jobs:
  analyze-and-update:
    name: åˆ†æ PR å¹¶æ›´æ–° CHANGELOG
    runs-on: ubuntu-latest
    if: github.event.pull_request.merged == true
    permissions:
      contents: write
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.MY_RELEASE_PAT || secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - name: æå– PR ä¿¡æ¯
        id: extract_pr_info
        run: |
          echo "PR æ ‡é¢˜: ${{ github.event.pull_request.title }}"
          echo "PR ç¼–å·: ${{ github.event.pull_request.number }}"
          echo "åˆå¹¶æ—¶é—´: $(date +'%Y-%m-%d')"
          
          # æå– PR æ ‡ç­¾
          LABELS="${{ join(github.event.pull_request.labels.*.name, ',') }}"
          echo "PR æ ‡ç­¾: $LABELS"
          echo "labels=$LABELS" >> $GITHUB_OUTPUT
      
      - name: åˆ†æ PR ç±»å‹
        id: analyze_type
        run: |
          TITLE="${{ github.event.pull_request.title }}"
          LABELS="${{ steps.extract_pr_info.outputs.labels }}"
          
          # æ ¹æ® PR æ ‡ç­¾ç¡®å®šç±»å‹
          if echo "$LABELS" | grep -q "enhancement"; then
            CHANGE_TYPE="æ–°å¢"
          elif echo "$LABELS" | grep -q "bug"; then
            CHANGE_TYPE="ä¿®å¤"
          elif echo "$LABELS" | grep -q "documentation"; then
            CHANGE_TYPE="æ–‡æ¡£"
          elif echo "$LABELS" | grep -q "refactor"; then
            CHANGE_TYPE="é‡æ„"
          elif echo "$LABELS" | grep -q "performance"; then
            CHANGE_TYPE="ä¼˜åŒ–"
          else
            # æ ¹æ®æ ‡é¢˜å‰ç¼€åˆ¤æ–­
            if echo "$TITLE" | grep -qiE "^(feat|add|new|æ–°å¢|æ·»åŠ )"; then
              CHANGE_TYPE="æ–°å¢"
            elif echo "$TITLE" | grep -qiE "^(fix|bug|ä¿®å¤)"; then
              CHANGE_TYPE="ä¿®å¤"
            elif echo "$TITLE" | grep -qiE "^(doc|docs|readme|æ›´æ–°æ–‡æ¡£)"; then
              CHANGE_TYPE="æ–‡æ¡£"
            elif echo "$TITLE" | grep -qiE "^(refactor|é‡æ„)"; then
              CHANGE_TYPE="é‡æ„"
            elif echo "$TITLE" | grep -qiE "^(perf|performance|ä¼˜åŒ–)"; then
              CHANGE_TYPE="ä¼˜åŒ–"
            else
              CHANGE_TYPE="æ”¹è¿›"
            fi
          fi
          
          echo "change_type=$CHANGE_TYPE" >> $GITHUB_OUTPUT
          echo "å˜æ›´ç±»å‹: $CHANGE_TYPE"
      
      - name: æå–æäº¤ä¿¡æ¯
        id: extract_commits
        run: |
          COMMITS=$(git log --pretty=format:"%s" ${{ github.event.pull_request.base.sha }}..${{ github.event.pull_request.head.sha }})
          echo "commits<<EOF" >> $GITHUB_OUTPUT
          echo "$COMMITS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          echo "ç›¸å…³æäº¤:"
          echo "$COMMITS"
      
      - name: è¯»å–å½“å‰ç‰ˆæœ¬å’Œæœ€æ–°æ¡ç›®
        id: read_current_version
        run: |
          # è¯»å– main.py ä¸­çš„å½“å‰ç‰ˆæœ¬å·
          if [ -f main.py ]; then
            CURRENT_VERSION=$(grep -o "__version__ = \"[^\"]*\"" main.py | cut -d'"' -f2)
          else
            CURRENT_VERSION="æœªçŸ¥ç‰ˆæœ¬"
          fi
          echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "main.py å½“å‰ç‰ˆæœ¬: $CURRENT_VERSION"
          
          # è¯»å– CHANGELOG.md ä¸­è®°å½•çš„æœ€æ–°ç‰ˆæœ¬å·
          LAST_VERSION=$(grep -oP '^## \[\K[^\]]+' CHANGELOG.md | head -1)
          echo "last_version=$LAST_VERSION" >> $GITHUB_OUTPUT
          echo "CHANGELOG æœ€æ–°ç‰ˆæœ¬: $LAST_VERSION"
          
          # è·å–ä»Šå¤©æ—¥æœŸ
          TODAY=$(date +'%Y-%m-%d')
          echo "today=$TODAY" >> $GITHUB_OUTPUT
          echo "ä»Šå¤©æ—¥æœŸ: $TODAY"
          
          # è¯»å– CHANGELOG æœ€æ–°æ¡ç›®çš„æ—¥æœŸ
          LAST_DATE=$(head -n 5 CHANGELOG.md | grep -oP '\d{4}-\d{2}-\d{2}' | head -1)
          if [ -z "$LAST_DATE" ]; then
            LAST_DATE=""
          fi
          echo "last_date=$LAST_DATE" >> $GITHUB_OUTPUT
          echo "æœ€æ–°æ¡ç›®æ—¥æœŸ: $LAST_DATE"
          
          # åˆ¤æ–­æ˜¯å¦éœ€è¦åˆ›å»ºæ–°ç‰ˆæœ¬å—
          if [ "$CURRENT_VERSION" = "$LAST_VERSION" ]; then
            # ç‰ˆæœ¬å·ç›¸åŒï¼Œè¿½åŠ åˆ°å½“å‰ç‰ˆæœ¬
            if [ "$LAST_DATE" = "$TODAY" ]; then
              echo "mode=append_today" >> $GITHUB_OUTPUT
              echo "æ¨¡å¼: è¿½åŠ åˆ°å½“å¤©æ¡ç›®"
            else
              echo "mode=append_existing" >> $GITHUB_OUTPUT
              echo "æ¨¡å¼: è¿½åŠ åˆ°ç°æœ‰ç‰ˆæœ¬ï¼ˆä¸åŒæ—¥æœŸï¼‰"
            fi
          else
            # ç‰ˆæœ¬å·ä¸åŒï¼Œåˆ›å»ºæ–°ç‰ˆæœ¬å—
            echo "mode=new" >> $GITHUB_OUTPUT
            echo "æ¨¡å¼: åˆ›å»ºæ–°ç‰ˆæœ¬å— ($CURRENT_VERSION > $LAST_VERSION)"
          fi
      
      - name: ç”Ÿæˆ Changelog æ¡ç›®
        id: generate_changelog
        run: |
          CURRENT_VERSION="${{ steps.read_current_version.outputs.current_version }}"
          TODAY="${{ steps.read_current_version.outputs.today }}"
          MODE="${{ steps.read_current_version.outputs.mode }}"
          CHANGE_TYPE="${{ steps.analyze_type.outputs.change_type }}"
          TITLE="${{ github.event.pull_request.title }}"
          COMMITS="${{ steps.extract_commits.outputs.commits }}"
          PR_NUM="${{ github.event.pull_request.number }}"
          
          # æ ¹æ®æ¨¡å¼ç”Ÿæˆä¸åŒçš„æ¡ç›®æ ¼å¼
          if [ "$MODE" = "new" ]; then
            # æ–°ç‰ˆæœ¬æ¨¡å¼ï¼šç”Ÿæˆå®Œæ•´çš„ç‰ˆæœ¬å—
            {
              echo "## [\${VERSION}] - \${DATE}"
              echo ""
              echo "### \${CHANGE_TYPE}"
              echo "- \${TITLE} (PR #\${PR_NUM})"
              echo ""
            } > changelog_entry.txt
            # å¤„ç†æäº¤ä¿¡æ¯
            if [ -n "$COMMITS" ]; then
              echo "$COMMITS" | while IFS= read -r commit; do
                echo "- $commit" >> changelog_entry.txt
              done
            fi
            {
              echo ""
              echo "---"
              echo ""
            } >> changelog_entry.txt
          else
            # è¿½åŠ æ¨¡å¼ï¼šåªç”Ÿæˆåˆ†ç±»å’Œæ¡ç›®
            {
              echo "### \${CHANGE_TYPE}"
              echo "- **\${TITLE}** (PR #\${PR_NUM})"
              echo ""
            } > changelog_entry.txt
          fi
          
          # æ›¿æ¢å˜é‡ï¼ˆä½¿ç”¨ä¸´æ—¶æ–‡ä»¶é¿å…æ›¿æ¢é—®é¢˜ï¼‰
          sed "s/\${VERSION}/${CURRENT_VERSION}/g; s/\${DATE}/${TODAY}/g; s/\${CHANGE_TYPE}/${CHANGE_TYPE}/g; s/\${TITLE}/${TITLE}/g; s/\${PR_NUM}/${PR_NUM}/g" changelog_entry.txt > changelog_entry.tmp
          mv changelog_entry.tmp changelog_entry.txt
          
          echo "entry_file=changelog_entry.txt" >> $GITHUB_OUTPUT
          
          # åŒæ—¶è¾“å‡ºchangelogå†…å®¹åˆ°GITHUB_OUTPUTï¼ˆç”¨äºPRè¯„è®ºï¼‰
          echo "entry<<EOF" >> $GITHUB_OUTPUT
          cat changelog_entry.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          echo "ç”Ÿæˆçš„ Changelog æ¡ç›®:"
          cat changelog_entry.txt
      
      - name: æ›´æ–° CHANGELOG.md
        run: |
          ENTRY_FILE="${{ steps.generate_changelog.outputs.entry_file }}"
          MODE="${{ steps.read_current_version.outputs.mode }}"
          
          if [ "$MODE" = "new" ]; then
            # æ–°ç‰ˆæœ¬æ¨¡å¼ï¼šåœ¨æ–‡ä»¶æ ‡é¢˜ä¹‹åæ’å…¥æ–°ç‰ˆæœ¬å—
            awk -v entry_file="$ENTRY_FILE" '
              BEGIN { 
                inserted = 0
                # è¯»å–æ–°æ¡ç›®åˆ°æ•°ç»„
                while ((getline line < entry_file) > 0) {
                  new_entries[++n] = line
                }
                close(entry_file)
              }
              /^## \[/ && inserted == 0 {
                # åœ¨ç¬¬ä¸€ä¸ªç‰ˆæœ¬å—ä¹‹å‰æ’å…¥æ–°æ¡ç›®
                for (i = 1; i <= n; i++) {
                  print new_entries[i]
                }
                print ""
                inserted = 1
              }
              { print }
            ' CHANGELOG.md > CHANGELOG.md.new
            mv CHANGELOG.md.new CHANGELOG.md
          else
            # è¿½åŠ æ¨¡å¼ï¼šåœ¨å½“å‰ç‰ˆæœ¬å—çš„ç¬¬ä¸€ä¸ª ### åˆ†ç±»ä¹‹å‰æ’å…¥
            awk -v entry_file="$ENTRY_FILE" '
              BEGIN { 
                inserted = 0
                in_version = 0
                # è¯»å–æ–°æ¡ç›®åˆ°æ•°ç»„
                while ((getline line < entry_file) > 0) {
                  new_entries[++n] = line
                }
                close(entry_file)
              }
              /^## \[/ {
                in_version = 1
              }
              /^### / && in_version == 1 && inserted == 0 {
                # åœ¨å½“å‰ç‰ˆæœ¬å—çš„ç¬¬ä¸€ä¸ªåˆ†ç±»ä¹‹å‰æ’å…¥æ–°æ¡ç›®
                for (i = 1; i <= n; i++) {
                  print new_entries[i]
                }
                print ""
                inserted = 1
              }
              { print }
            ' CHANGELOG.md > CHANGELOG.md.new
            mv CHANGELOG.md.new CHANGELOG.md
          fi
          
          # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
          rm -f changelog_entry.txt
          
          echo "âœ… CHANGELOG.mdå·²æ›´æ–°"
          echo "---"
          head -n 30 CHANGELOG.md
      
      - name: æäº¤æ›´æ”¹
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add CHANGELOG.md
          git commit -m "docs: è‡ªåŠ¨æ›´æ–° CHANGELOG - PR #${{ github.event.pull_request.number }}"
          
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.MY_RELEASE_PAT || secrets.GITHUB_TOKEN }}
      
      - name: å‘é€è¯„è®ºåˆ° PR
        uses: actions/github-script@v7
        with:
          script: |
            const changelog = `${{ steps.generate_changelog.outputs.entry }}`;
            github.rest.issues.createComment({
              issue_number: context.payload.pull_request.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `ğŸ“ **å·²è‡ªåŠ¨æ›´æ–° CHANGELOG.md**\n\n${changelog}\n\n---\n\nâœ… æ­¤æ¡ç›®å°†åœ¨ä¸‹æ¬¡ Release æ—¶åŒ…å«åœ¨å‘å¸ƒè¯´æ˜ä¸­ã€‚`
            })