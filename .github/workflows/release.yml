name: Create Release

on:
  push:
    tags:
      - 'v*'  # åŒ¹é… v å¼€å¤´çš„æ ‡ç­¾ï¼Œå¦‚ v1.0.0, v1.2.3

jobs:
  create-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–æ‰€æœ‰å†å²è®°å½•ï¼Œç”¨äºç”Ÿæˆchangelog
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Extract version from tag
        id: get_version
        run: |
          # ä»tagä¸­æå–ç‰ˆæœ¬å·ï¼ˆç§»é™¤vå‰ç¼€ï¼‰
          VERSION="${GITHUB_REF#refs/tags/v}"
          echo "VERSION=${VERSION}" >> $GITHUB_OUTPUT
          echo "Extracted version: ${VERSION}"
      
      - name: Validate version format
        run: |
          # éªŒè¯ç‰ˆæœ¬å·æ ¼å¼æ˜¯å¦ç¬¦åˆè¯­ä¹‰åŒ–ç‰ˆæœ¬
          VERSION="${{ steps.get_version.outputs.VERSION }}"
          if [[ ! $VERSION =~ ^[0-9]+\.[0-9]+\.[0-9]+(-[0-9A-Za-z-]+(\.[0-9A-Za-z-]+)*)?(\+[0-9A-Za-z-]+(\.[0-9A-Za-z-]+)*)?$ ]]; then
            echo "é”™è¯¯: ç‰ˆæœ¬å· '$VERSION' ä¸ç¬¦åˆè¯­ä¹‰åŒ–ç‰ˆæœ¬æ ¼å¼"
            exit 1
          fi
          echo "ç‰ˆæœ¬å· '$VERSION' éªŒè¯é€šè¿‡"
      
      - name: Generate release notes
        id: generate_changelog
        run: |
          # ä»CHANGELOG.mdä¸­æå–å½“å‰ç‰ˆæœ¬çš„æ›´æ–°æ—¥å¿—
          VERSION="${{ steps.get_version.outputs.VERSION }}"
          
          # æŸ¥æ‰¾CHANGELOG.mdä¸­å¯¹åº”ç‰ˆæœ¬çš„éƒ¨åˆ†
          if [ -f "CHANGELOG.md" ]; then
            # ä½¿ç”¨awkæå–æŒ‡å®šç‰ˆæœ¬çš„å†…å®¹
            awk -v version="$VERSION" '
              BEGIN { in_section=0; found=0 }
              /^## \['version'\]/ { in_section=1; found=1; print; next }
              /^## \[/ && in_section { in_section=0 }
              in_section { print }
            ' CHANGELOG.md > release_notes.md
            
            if [ -s "release_notes.md" ]; then
              echo "ä»CHANGELOG.mdæˆåŠŸæå–ç‰ˆæœ¬ $VERSION çš„æ›´æ–°æ—¥å¿—"
              # å°†å†…å®¹è½¬æ¢ä¸ºå•è¡Œï¼Œç”¨äºGitHubè¾“å‡º
              NOTES=$(cat release_notes.md | sed ':a;N;$!ba;s/\n/\\n/g')
              echo "notes<<EOF" >> $GITHUB_OUTPUT
              echo "$NOTES" >> $GITHUB_OUTPUT
              echo "EOF" >> $GITHUB_OUTPUT
            else
              echo "è­¦å‘Š: åœ¨CHANGELOG.mdä¸­æœªæ‰¾åˆ°ç‰ˆæœ¬ $VERSION çš„æ›´æ–°æ—¥å¿—"
              echo "notes=## [$VERSION] - $(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT
            fi
          else
            echo "è­¦å‘Š: CHANGELOG.mdæ–‡ä»¶ä¸å­˜åœ¨"
            echo "notes=## [$VERSION] - $(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT
          fi
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          name: "Sakuraé¢‘é“æ€»ç»“åŠ©æ‰‹ v${{ steps.get_version.outputs.VERSION }}"
          body: "${{ steps.generate_changelog.outputs.notes }}"
          draft: false
          prerelease: false
          generate_release_notes: false
          files: |
            README.md
            CHANGELOG.md
            requirements.txt
            docker-compose.yml
            Dockerfile
      
      - name: Verify main.py version
        run: |
          # éªŒè¯main.pyä¸­çš„ç‰ˆæœ¬å·æ˜¯å¦ä¸tagä¸€è‡´
          VERSION="${{ steps.get_version.outputs.VERSION }}"
          PY_VERSION=$(grep -o "__version__ = \"[^\"]*\"" main.py | cut -d'"' -f2)
          
          if [ "$PY_VERSION" != "$VERSION" ]; then
            echo "é”™è¯¯: main.pyä¸­çš„ç‰ˆæœ¬å·($PY_VERSION)ä¸tagç‰ˆæœ¬($VERSION)ä¸ä¸€è‡´"
            echo "è¯·ç¡®ä¿åœ¨åˆ›å»ºtagå‰æ›´æ–°main.pyä¸­çš„ç‰ˆæœ¬å·"
            exit 1
          fi
          echo "ç‰ˆæœ¬éªŒè¯é€šè¿‡: main.pyä¸­çš„ç‰ˆæœ¬å·($PY_VERSION)ä¸tagç‰ˆæœ¬($VERSION)ä¸€è‡´"
      
      - name: Upload release assets
        run: |
          # åˆ›å»ºå‘å¸ƒåŒ…
          VERSION="${{ steps.get_version.outputs.VERSION }}"
          RELEASE_DIR="sakura-channel-summary-assistant-$VERSION"
          mkdir -p "$RELEASE_DIR"
          
          # å¤åˆ¶ä¸»è¦æ–‡ä»¶
          cp -r *.py *.txt *.md *.yml Dockerfile docker-entrypoint.sh "$RELEASE_DIR/" 2>/dev/null || true
          
          # åˆ›å»ºå‹ç¼©åŒ…
          tar -czf "sakura-channel-summary-assistant-$VERSION.tar.gz" "$RELEASE_DIR/"
          zip -r "sakura-channel-summary-assistant-$VERSION.zip" "$RELEASE_DIR/"
          
          # ä¸Šä¼ åˆ°release
          gh release upload "v$VERSION" "sakura-channel-summary-assistant-$VERSION.tar.gz" "sakura-channel-summary-assistant-$VERSION.zip" --clobber
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # å¯é€‰ï¼šè¿è¡Œæµ‹è¯•
  test:
    runs-on: ubuntu-latest
    needs: create-release
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Run basic tests
        run: |
          # è¿è¡Œç®€å•çš„å¯¼å…¥æµ‹è¯•
          python -c "import config; import main; print('å¯¼å…¥æµ‹è¯•é€šè¿‡')"
          python -c "from config import logger; logger.info('é…ç½®æ¨¡å—æµ‹è¯•é€šè¿‡')"

# å‘å¸ƒå®Œæˆåçš„é€šçŸ¥ï¼ˆå¯é€‰ï¼‰
#  notify:
#    runs-on: ubuntu-latest
#    needs: [create-release, test]
#    if: always()
#    
#    steps:
#      - name: Send notification
#        uses: appleboy/telegram-action@master
#        with:
#          to: ${{ secrets.TELEGRAM_CHAT_ID }}
#          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
#          message: |
#            ğŸš€ æ–°ç‰ˆæœ¬å‘å¸ƒæˆåŠŸï¼
#            ç‰ˆæœ¬: v${{ needs.create-release.outputs.version }}
#            ä»“åº“: ${{ github.repository }}
#            å‘å¸ƒåœ°å€: https://github.com/${{ github.repository }}/releases/tag/v${{ needs.create-release.outputs.version }}