name: åˆ†æ”¯è‡ªåŠ¨åŒæ­¥

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  sync-to-dev:
    name: åŒæ­¥ main â†’ dev
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - name: è·å–å½“å‰ç‰ˆæœ¬
        id: get_version
        run: |
          if [ -f main.py ]; then
            VERSION=$(grep -o "__version__ = \"[^\"]*\"" main.py | cut -d'"' -f2)
            echo "version=${VERSION}" >> $GITHUB_OUTPUT
            echo "å½“å‰ç‰ˆæœ¬: ${VERSION}"
          else
            echo "version=unknown" >> $GITHUB_OUTPUT
          fi
      
      - name: æ£€æŸ¥ dev åˆ†æ”¯æ˜¯å¦å­˜åœ¨
        id: check_dev
        run: |
          if git ls-remote --heads origin dev | grep -q "refs/heads/dev"; then
            echo "dev_exists=true" >> $GITHUB_OUTPUT
            echo "dev åˆ†æ”¯å­˜åœ¨"
          else
            echo "dev_exists=false" >> $GITHUB_OUTPUT
            echo "dev åˆ†æ”¯ä¸å­˜åœ¨ï¼Œå°†åˆ›å»º"
          fi
      
      - name: åˆ›å»ºæˆ–åˆ‡æ¢åˆ° dev åˆ†æ”¯
        run: |
          if [ "${{ steps.check_dev.outputs.dev_exists }}" == "true" ]; then
            git checkout dev
            git pull origin dev
          else
            git checkout -b dev
          fi
      
      - name: æå– main åˆ†æ”¯æœ€æ–°å˜åŠ¨
        id: get_commits
        run: |
          # è·å–æœ€è¿‘ 5 æ¡æäº¤ï¼Œå¹¶è¿›è¡Œç®€å•çš„æ ¼å¼åŒ–ï¼ˆæ·»åŠ åˆ—è¡¨ç¬¦å·ï¼‰
          COMMITS=$(git log origin/main -5 --pretty=format:"â€¢ %s")
          
          # å¤„ç†å¤šè¡Œå­—ç¬¦ä¸²è¾“å‡ºåˆ° GitHub Actions Step Output
          {
            echo 'commits_list<<EOF'
            echo "$COMMITS"
            echo 'EOF'
          } >> "$GITHUB_OUTPUT"
          
          echo "âœ… å·²è·å–æœ€è¿‘æäº¤ä¿¡æ¯"
      
      - name: åˆå¹¶ main åˆ° dev
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # å°è¯•åˆå¹¶
          if git merge origin/main --no-edit; then
            echo "âœ… åˆå¹¶æˆåŠŸ"
          else
            echo "âš ï¸ åˆå¹¶å†²çªï¼Œå°è¯•è§£å†³..."
            git status
            # å¦‚æœæœ‰å†²çªï¼Œé€‰æ‹© main çš„ç‰ˆæœ¬
            git checkout --ours .
            git add .
            git merge --continue --no-edit || git commit --no-edit -m "è‡ªåŠ¨åˆå¹¶ main åˆ° dev"
            echo "âœ… å·²è§£å†³å†²çª"
          fi
      
      - name: ç­‰å¾…å•å…ƒæµ‹è¯•å®Œæˆ
        uses: lewagon/wait-on-check-action@v1.3.1
        with:
          ref: ${{ github.sha }}
          check-name: 'å•å…ƒæµ‹è¯•'
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          wait-interval: 10
      
      - name: æ¨é€åˆ° dev
        run: |
          git push origin dev
          echo "âœ… å·²åŒæ­¥åˆ° dev åˆ†æ”¯"
      
      - name: å‘é€ Telegram é€šçŸ¥
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_ADMIN_CHANNEL_ID }}
        run: |
          if [ -n "$TELEGRAM_BOT_TOKEN" ] && [ -n "$TELEGRAM_CHAT_ID" ]; then
            VERSION="${{ steps.get_version.outputs.version }}"
            COMMITS="${{ steps.get_commits.outputs.commits_list }}"
            
            MESSAGE="ğŸ”„ **åˆ†æ”¯åŒæ­¥é€šçŸ¥**
            
            main åˆ†æ”¯å·²è‡ªåŠ¨åŒæ­¥åˆ° dev åˆ†æ”¯
            
            ğŸ“¦ ç‰ˆæœ¬: v${VERSION}
            ğŸš€ åŒæ­¥æ—¶é—´: $(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M:%S (UTC+8)')
            
            ğŸ“ æœ€è¿‘æäº¤:
            ${COMMITS}
            
            ---
            ç”± GitHub Actions è‡ªåŠ¨æ‰§è¡Œ"
            
            # å‘é€æ¶ˆæ¯åˆ° Telegram
            curl -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
              -d "chat_id=${TELEGRAM_CHAT_ID}" \
              -d "text=${MESSAGE}" \
              -d "parse_mode=Markdown" \
              -d "disable_web_page_preview=true"
            
            echo "âœ… Telegram é€šçŸ¥å·²å‘é€"
          else
            echo "âš ï¸ æœªé…ç½® Telegram é€šçŸ¥"
          fi
