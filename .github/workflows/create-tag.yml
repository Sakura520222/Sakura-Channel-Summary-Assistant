name: è‡ªåŠ¨åˆ›å»º Release

on:
  push:
    branches:
      - main
    paths:
      - 'main.py'
      - 'core/**/*.py'
      - 'CHANGELOG.md'
  workflow_dispatch:

jobs:
  analyze-changes:
    name: åˆ†æä»£ç å˜æ›´
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: åˆ†æè‡ªä¸Šæ¬¡å‘å¸ƒä»¥æ¥çš„å˜æ›´
        id: analyze
        run: |
          # è·å–æœ€æ–°çš„ tag
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          
          if [ -z "$LATEST_TAG" ]; then
            echo "æœªæ‰¾åˆ°ä¹‹å‰çš„ tagï¼Œåˆ†ææ‰€æœ‰æäº¤"
            BASE_SHA=$(git rev-list --max-parents=0 HEAD)
          else
            echo "æœ€æ–° tag: $LATEST_TAG"
            BASE_SHA=$(git rev-list -n 1 $LATEST_TAG)
          fi
          
          echo "base_sha=$BASE_SHA" >> $GITHUB_OUTPUT
          echo "latest_tag=$LATEST_TAG" >> $GITHUB_OUTPUT
          
          # è·å–æ‰€æœ‰ç›¸å…³æäº¤
          COMMITS=$(git log --pretty=format:"%h|%s|%an|%ae" $BASE_SHA..HEAD)
          
          # ç»Ÿè®¡æäº¤æ•°é‡
          COMMIT_COUNT=$(echo "$COMMITS" | wc -l)
          echo "commit_count=$COMMIT_COUNT" >> $GITHUB_OUTPUT
          echo "æäº¤æ•°é‡: $COMMIT_COUNT"
          
          # æå– PR ç¼–å·
          PR_NUMBERS=$(echo "$COMMITS" | grep -oE "#[0-9]+" | sort -u | tr '\n' ',')
          echo "pr_numbers=$PR_NUMBERS" >> $GITHUB_OUTPUT
          echo "ç›¸å…³ PR: $PR_NUMBERS"
          
          # æå–æ‰€æœ‰æäº¤ä¿¡æ¯
          echo "commits<<EOF" >> $GITHUB_OUTPUT
          echo "$COMMITS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      
      - name: è¾“å‡ºåˆ†æç»“æœ
        run: |
          echo "## å˜æ›´åˆ†æç»“æœ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- æœ€æ–° tag: ${{ steps.analyze.outputs.latest_tag }}" >> $GITHUB_STEP_SUMMARY
          echo "- æäº¤æ•°é‡: ${{ steps.analyze.outputs.commit_count }}" >> $GITHUB_STEP_SUMMARY
          echo "- ç›¸å…³ PR: ${{ steps.analyze.outputs.pr_numbers }}" >> $GITHUB_STEP_SUMMARY
    
    outputs:
      base_sha: ${{ steps.analyze.outputs.base_sha }}
      latest_tag: ${{ steps.analyze.outputs.latest_tag }}
      commit_count: ${{ steps.analyze.outputs.commit_count }}
      pr_numbers: ${{ steps.analyze.outputs.pr_numbers }}
      commits: ${{ steps.analyze.outputs.commits }}

  create-release:
    name: åˆ›å»º GitHub Release
    runs-on: ubuntu-latest
    needs: analyze-changes
    permissions:
      contents: write
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: éªŒè¯é¡¹ç›®ç»“æ„
        run: |
          if [ ! -f "main.py" ]; then
            echo "âŒ é”™è¯¯: main.py æ–‡ä»¶ä¸å­˜åœ¨"
            exit 1
          fi
          if [ ! -f "requirements.txt" ]; then
            echo "âŒ é”™è¯¯: requirements.txt æ–‡ä»¶ä¸å­˜åœ¨"
            exit 1
          fi
          if [ ! -d "core" ]; then
            echo "âŒ é”™è¯¯: core ç›®å½•ä¸å­˜åœ¨"
            exit 1
          fi
          echo "âœ… é¡¹ç›®ç»“æ„éªŒè¯é€šè¿‡"
      
      - name: è®¾ç½® Python 3.13
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'
      
      - name: è·å–å½“å‰ç‰ˆæœ¬
        id: get_version
        run: |
          if [ -f "main.py" ]; then
            PY_VERSION=$(grep -o "__version__ = \"[^\"]*\"" main.py | cut -d'"' -f2)
            echo "PY_VERSION=${PY_VERSION}" >> $GITHUB_OUTPUT
            echo "å½“å‰ç‰ˆæœ¬: ${PY_VERSION}"
          else
            echo "âŒ é”™è¯¯: main.py æ–‡ä»¶ä¸å­˜åœ¨"
            exit 1
          fi
      
      - name: æ£€æŸ¥ç‰ˆæœ¬æ˜¯å¦å·²å­˜åœ¨
        id: check_version
        run: |
          VERSION="${{ steps.get_version.outputs.PY_VERSION }}"
          TAG_NAME="v${VERSION}"
          
          if gh release view "$TAG_NAME" >/dev/null 2>&1; then
            echo "âš ï¸ ç‰ˆæœ¬ $VERSION çš„å‘å¸ƒå·²å­˜åœ¨ï¼Œå°†è·³è¿‡åˆ›å»º"
            echo "SHOULD_CREATE=false" >> $GITHUB_OUTPUT
          else
            echo "âœ… ç‰ˆæœ¬ $VERSION æ˜¯æ–°ç‰ˆæœ¬ï¼Œå°†åˆ›å»ºå‘å¸ƒ"
            echo "SHOULD_CREATE=true" >> $GITHUB_OUTPUT
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ç”Ÿæˆå‘å¸ƒä¿¡æ¯
        if: steps.check_version.outputs.SHOULD_CREATE == 'true'
        id: generate_release_info
        run: |
          VERSION="${{ steps.get_version.outputs.PY_VERSION }}"
          TAG_NAME="v${VERSION}"
          echo "RELEASE_NAME=${TAG_NAME}" >> $GITHUB_OUTPUT
          echo "å‘å¸ƒæ ‡ç­¾: ${TAG_NAME}"
          
          RELEASE_TITLE="ğŸš€ Release v${VERSION}"
          echo "RELEASE_TITLE=${RELEASE_TITLE}" >> $GITHUB_OUTPUT
      
      - name: ä» CHANGELOG ç”Ÿæˆå‘å¸ƒè¯´æ˜
        id: generate_changelog
        if: steps.check_version.outputs.SHOULD_CREATE == 'true'
        run: |
          VERSION="${{ steps.get_version.outputs.PY_VERSION }}"
          
          if [ -f "CHANGELOG.md" ]; then
            # æå–å½“å‰ç‰ˆæœ¬çš„å˜æ›´æ—¥å¿—
            awk -v version="$VERSION" '
              BEGIN { in_section=0; found=0 }
              index($0, "## [" version "]") == 1 { in_section=1; found=1; print; next }
              /^## \[/ && in_section { in_section=0 }
              in_section { print }
            ' CHANGELOG.md > release_notes.md
            
            if [ -s "release_notes.md" ]; then
              echo "notes<<EOF" >> $GITHUB_OUTPUT
              cat release_notes.md >> $GITHUB_OUTPUT
              echo "EOF" >> $GITHUB_OUTPUT
            else
              echo "æœªåœ¨ CHANGELOG ä¸­æ‰¾åˆ°ç‰ˆæœ¬ $VERSION çš„æ¡ç›®" >&2
            fi
          fi
          
          # å¦‚æœæ²¡æœ‰æ‰¾åˆ°ï¼Œç”ŸæˆåŸºæœ¬çš„å‘å¸ƒè¯´æ˜
          if [ ! -s "release_notes.md" ]; then
            COMMITS_COUNT="${{ needs.analyze-changes.outputs.commit_count }}"
            PR_NUMBERS="${{ needs.analyze-changes.outputs.pr_numbers }}"
            
            echo "notes<<EOF" >> $GITHUB_OUTPUT
            echo "## ğŸ‰ Release v${VERSION}" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
            echo "**å‘å¸ƒæ—¥æœŸ**: $(date +'%Yå¹´%mæœˆ%dæ—¥')" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
            echo "### ğŸ“Š å˜æ›´ç»Ÿè®¡" >> $GITHUB_OUTPUT
            echo "- åŒ…å«æäº¤æ•°: ${COMMITS_COUNT}" >> $GITHUB_OUTPUT
            if [ -n "$PR_NUMBERS" ]; then
              echo "- ç›¸å…³ PR: ${PR_NUMBERS}" >> $GITHUB_OUTPUT
            fi
            echo "" >> $GITHUB_OUTPUT
            echo "### ğŸ“ ä¸»è¦å˜æ›´" >> $GITHUB_OUTPUT
            echo "è¯·æŸ¥çœ‹ [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md) è·å–è¯¦ç»†ä¿¡æ¯" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi
      
      - name: åˆ›å»º GitHub Release
        if: steps.check_version.outputs.SHOULD_CREATE == 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.generate_release_info.outputs.RELEASE_NAME }}
          name: ${{ steps.generate_release_info.outputs.RELEASE_TITLE }}
          body: "${{ steps.generate_changelog.outputs.notes }}"
          draft: false
          prerelease: false
          generate_release_notes: false
      
      - name: åˆ›å»ºå‘å¸ƒèµ„æºåŒ…
        if: steps.check_version.outputs.SHOULD_CREATE == 'true'
        run: |
          VERSION="${{ steps.get_version.outputs.PY_VERSION }}"
          RELEASE_NAME="${{ steps.generate_release_info.outputs.RELEASE_NAME }}"
          RELEASE_DIR="Sakura-Bot-${RELEASE_NAME}"
          
          mkdir -p "$RELEASE_DIR"
          
          echo "ğŸ“¦ æ­£åœ¨æ‰“åŒ…å‘å¸ƒèµ„æº..."
          
          # å¤åˆ¶æ ¸å¿ƒä»£ç 
          if [ -f "main.py" ]; then cp main.py "$RELEASE_DIR/"; fi
          if [ -f "qa_bot.py" ]; then cp qa_bot.py "$RELEASE_DIR/"; fi
          find core -name "*.py" -exec cp --parents {} "$RELEASE_DIR/" \;
          rm -rf "$RELEASE_DIR/core/__pycache__"
          
          # åˆ›å»ºå¿…è¦çš„ç›®å½•
          mkdir -p "$RELEASE_DIR/data"
          mkdir -p "$RELEASE_DIR/data/sessions"
          mkdir -p "$RELEASE_DIR/data/vectors"
          
          # å¤åˆ¶é…ç½®æ–‡ä»¶
          [ -f "data/.env.example" ] && cp "data/.env.example" "$RELEASE_DIR/data/"
          [ -f "data/config.example.json" ] && cp "data/config.example.json" "$RELEASE_DIR/data/"
          [ -f "data/prompt.txt" ] && cp "data/prompt.txt" "$RELEASE_DIR/data/"
          [ -f "data/poll_prompt.txt" ] && cp "data/poll_prompt.txt" "$RELEASE_DIR/data/"
          [ -f "data/qa_persona.txt" ] && cp "data/qa_persona.txt" "$RELEASE_DIR/data/"
          
          # å¤åˆ¶å¿…è¦æ–‡ä»¶
          [ -f "requirements.txt" ] && cp requirements.txt "$RELEASE_DIR/"
          [ -f "README.md" ] && cp README.md "$RELEASE_DIR/"
          [ -f "README_EN.md" ] && cp README_EN.md "$RELEASE_DIR/"
          [ -f "CHANGELOG.md" ] && cp CHANGELOG.md "$RELEASE_DIR/"
          [ -f "LICENSE" ] && cp LICENSE "$RELEASE_DIR/"
          
          # å¤åˆ¶å¯åŠ¨è„šæœ¬
          [ -f "start.bat" ] && cp start.bat "$RELEASE_DIR/"
          [ -f "start.sh" ] && cp start.sh "$RELEASE_DIR/"
          
          # å¤åˆ¶ Docker æ–‡ä»¶
          [ -f "Dockerfile" ] && cp Dockerfile "$RELEASE_DIR/"
          [ -f "docker-compose.yml" ] && cp docker-compose.yml "$RELEASE_DIR/"
          [ -f "docker-entrypoint.sh" ] && cp docker-entrypoint.sh "$RELEASE_DIR/"
          [ -f ".dockerignore" ] && cp .dockerignore "$RELEASE_DIR/"
          
          # è®¾ç½®å¯æ‰§è¡Œæƒé™
          chmod +x "$RELEASE_DIR/start.sh" 2>/dev/null || true
          chmod +x "$RELEASE_DIR/docker-entrypoint.sh" 2>/dev/null || true
          
          # åˆ›å»ºå‹ç¼©åŒ…
          echo "æ­£åœ¨åˆ›å»ºå‹ç¼©åŒ…..."
          tar -czf "${RELEASE_DIR}.tar.gz" "$RELEASE_DIR/"
          zip -q -r "${RELEASE_DIR}.zip" "$RELEASE_DIR/"
          
          echo "âœ… èµ„æºåŒ…åˆ›å»ºå®Œæˆ"
      
      - name: ä¸Šä¼ å‘å¸ƒèµ„æº
        if: steps.check_version.outputs.SHOULD_CREATE == 'true'
        run: |
          RELEASE_NAME="${{ steps.generate_release_info.outputs.RELEASE_NAME }}"
          ASSET_NAME="Sakura-Bot-${RELEASE_NAME}"
          
          echo "æ­£åœ¨ä¸Šä¼ èµ„æºåˆ° Release..."
          gh release upload "$RELEASE_NAME" "${ASSET_NAME}.tar.gz" "${ASSET_NAME}.zip" --clobber
          
          echo "âœ… èµ„æºä¸Šä¼ å®Œæˆ"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: å‘é€ Telegram é€šçŸ¥
        if: steps.check_version.outputs.SHOULD_CREATE == 'true'
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_ADMIN_CHANNEL_ID }}
        run: |
          if [ -n "$TELEGRAM_BOT_TOKEN" ] && [ -n "$TELEGRAM_CHAT_ID" ]; then
            VERSION="${{ steps.get_version.outputs.PY_VERSION }}"
            COMMITS_COUNT="${{ needs.analyze-changes.outputs.commit_count }}"
            PR_NUMBERS="${{ needs.analyze-changes.outputs.pr_numbers }}"
            RELEASE_URL="https://github.com/${{ github.repository }}/releases/tag/v${VERSION}"
            
            MESSAGE="ğŸš€ **æ–°ç‰ˆæœ¬å‘å¸ƒé€šçŸ¥**
            
            Sakura-Bot v${VERSION} å·²å‘å¸ƒï¼
            
            ğŸ“¦ ç‰ˆæœ¬: v${VERSION}
            ğŸ“Š åŒ…å«æäº¤: ${COMMITS_COUNT} ä¸ª
            
            ğŸ“ ç›¸å…³ PR: ${PR_NUMBERS}
            
            ğŸ“¥ **ä¸‹è½½é“¾æ¥**:
            ${RELEASE_URL}
            
            ---
            ç”± GitHub Actions è‡ªåŠ¨å‘å¸ƒ"
            
            # å‘é€æ¶ˆæ¯åˆ° Telegram
            curl -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
              -d "chat_id=${TELEGRAM_CHAT_ID}" \
              -d "text=${MESSAGE}" \
              -d "parse_mode=Markdown" \
              -d "disable_web_page_preview=true"
            
            echo "âœ… Telegram é€šçŸ¥å·²å‘é€"
          else
            echo "âš ï¸ æœªé…ç½® Telegram é€šçŸ¥"
          fi
      
      - name: ç”Ÿæˆå‘å¸ƒæ‘˜è¦
        if: steps.check_version.outputs.SHOULD_CREATE == 'true'
        run: |
          VERSION="${{ steps.get_version.outputs.PY_VERSION }}"
          RELEASE_NAME="${{ steps.generate_release_info.outputs.RELEASE_NAME }}"
          RELEASE_URL="https://github.com/${{ github.repository }}/releases/tag/${RELEASE_NAME}"
          
          echo "# ğŸš€ Release ${RELEASE_NAME} åˆ›å»ºæˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… ç‰ˆæœ¬: **v${VERSION}**" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ“Š åŒ…å«æäº¤: **${{ needs.analyze-changes.outputs.commit_count }}** ä¸ª" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ”— å‘å¸ƒé¡µé¢: [${RELEASE_URL}](${RELEASE_URL})" >> $GITHUB_STEP_SUMMARY
      
      - name: æ¸…ç†ä¸´æ—¶æ–‡ä»¶
        if: always()
        run: |
          rm -f release_notes.md
          VERSION="${{ steps.get_version.outputs.PY_VERSION }}"
          rm -rf "Sakura-Bot-v${VERSION}"
          rm -f "Sakura-Bot-v${VERSION}.tar.gz"
          rm -f "Sakura-Bot-v${VERSION}.zip"
          echo "âœ… ä¸´æ—¶æ–‡ä»¶å·²æ¸…ç†"