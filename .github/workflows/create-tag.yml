name: Auto Create Release

on:
  push:
    branches:
      - main
    paths:
      - 'main.py'
      - 'CHANGELOG.md'

jobs:
  create-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Get current version
        id: get_version
        run: |
          # 从main.py中提取版本号
          if [ -f "main.py" ]; then
            PY_VERSION=$(grep -o "__version__ = \"[^\"]*\"" main.py | cut -d'"' -f2)
            echo "PY_VERSION=${PY_VERSION}" >> $GITHUB_OUTPUT
            echo "当前版本: ${PY_VERSION}"
          else
            echo "错误: main.py文件不存在"
            exit 1
          fi
      
      - name: Generate release name
        id: generate_release_info
        run: |
          VERSION="${{ steps.get_version.outputs.PY_VERSION }}"
          
          # 检查标签是否已存在
          TAG_NAME="v${VERSION}"
          if git rev-parse "$TAG_NAME" >/dev/null 2>&1; then
            echo "标签 $TAG_NAME 已存在，将更新现有发行版"
            TAG_EXISTS=true
          else
            echo "标签 $TAG_NAME 不存在，将创建新标签"
            TAG_EXISTS=false
          fi
          
          # 使用标准标签名称
          echo "RELEASE_NAME=${TAG_NAME}" >> $GITHUB_OUTPUT
          echo "TAG_EXISTS=${TAG_EXISTS}" >> $GITHUB_OUTPUT
          echo "发布标签: ${TAG_NAME}"
          
          # 生成标准发布标题
          RELEASE_TITLE="Release v${VERSION}"
          echo "RELEASE_TITLE=${RELEASE_TITLE}" >> $GITHUB_OUTPUT
      
      - name: Generate release notes from CHANGELOG
        id: generate_changelog
        run: |
          VERSION="${{ steps.get_version.outputs.PY_VERSION }}"
          
          # 从CHANGELOG.md中提取当前版本的更新日志
          if [ -f "CHANGELOG.md" ]; then
            # 查找CHANGELOG.md中对应版本的部分
            awk -v version="$VERSION" '
              BEGIN { in_section=0; found=0 }
              index($0, "## [" version "]") == 1 { in_section=1; found=1; print; next }
              /^## \[/ && in_section { in_section=0 }
              in_section { print }
            ' CHANGELOG.md > release_notes.md
            
            if [ -s "release_notes.md" ]; then
              echo "从CHANGELOG.md成功提取版本 $VERSION 的更新日志"
              # 直接输出多行内容
              echo "notes<<EOF" >> $GITHUB_OUTPUT
              cat release_notes.md >> $GITHUB_OUTPUT
              echo "EOF" >> $GITHUB_OUTPUT
            else
              echo "警告: 在CHANGELOG.md中未找到版本 $VERSION 的更新日志"
              COMMIT_MSG="${{ github.event.head_commit.message }}"
              echo "notes<<EOF" >> $GITHUB_OUTPUT
              echo "## [$VERSION] - $(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT
              echo "" >> $GITHUB_OUTPUT
              echo "基于提交: $COMMIT_MSG" >> $GITHUB_OUTPUT
              echo "EOF" >> $GITHUB_OUTPUT
            fi
          else
            echo "警告: CHANGELOG.md文件不存在"
            COMMIT_MSG="${{ github.event.head_commit.message }}"
            echo "notes<<EOF" >> $GITHUB_OUTPUT
            echo "## [$VERSION] - $(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
            echo "基于提交: $COMMIT_MSG" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.generate_release_info.outputs.RELEASE_NAME }}
          name: ${{ steps.generate_release_info.outputs.RELEASE_TITLE }}
          body: "${{ steps.generate_changelog.outputs.notes }}"
          draft: false
          prerelease: false
          generate_release_notes: false
          # 不再上传单个文件，只通过后续步骤上传压缩包
      
      - name: Create release assets
        run: |
          VERSION="${{ steps.get_version.outputs.PY_VERSION }}"
          RELEASE_NAME="${{ steps.generate_release_info.outputs.RELEASE_NAME }}"
          RELEASE_DIR="sakura-channel-summary-assistant-${RELEASE_NAME}"
          
          echo "创建发布资源包: 版本=$VERSION, 发布名称=$RELEASE_NAME"
          mkdir -p "$RELEASE_DIR"
          
          # 复制主要文件
          cp -r *.py *.txt *.md *.yml Dockerfile docker-entrypoint.sh "$RELEASE_DIR/" 2>/dev/null || true

          # 复制许可证文件
          if [ -f "LICENSE" ]; then
            cp LICENSE "$RELEASE_DIR/"
            echo "已复制LICENSE文件"
          fi

          # 复制环境变量示例文件
          if [ -f ".env.example" ]; then
            cp .env.example "$RELEASE_DIR/"
            echo "已复制.env.example文件"
          fi
          
          # 创建压缩包
          tar -czf "sakura-channel-summary-assistant-${RELEASE_NAME}.tar.gz" "$RELEASE_DIR/"
          zip -r "sakura-channel-summary-assistant-${RELEASE_NAME}.zip" "$RELEASE_DIR/"
          
          echo "发布资源包创建完成，包含所有必要文件"
      
      - name: Upload release assets
        run: |
          RELEASE_NAME="${{ steps.generate_release_info.outputs.RELEASE_NAME }}"
          echo "上传发布资源到: $RELEASE_NAME"
          
          # 上传到release
          gh release upload "$RELEASE_NAME" \
            "sakura-channel-summary-assistant-${RELEASE_NAME}.tar.gz" \
            "sakura-channel-summary-assistant-${RELEASE_NAME}.zip" \
            --clobber
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
