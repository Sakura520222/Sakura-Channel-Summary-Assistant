{% extends "base.html" %}

{% block title %}配置管理{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4">
            <i class="bi bi-gear me-2"></i>配置管理
        </h1>
    </div>
</div>

<!-- AI配置 -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-robot me-2"></i>AI配置
                </h5>
            </div>
            <div class="card-body">
                <form id="aiConfigForm" method="post" action="/api/update_config">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="aiApiKey" class="form-label">API密钥</label>
                            <input type="password" class="form-control" id="aiApiKey" name="ai_api_key" 
                                   value="{{ ai_api_key }}" placeholder="输入API密钥">
                            <div class="form-text">
                                当前显示前10位: {{ ai_api_key }}
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="aiBaseUrl" class="form-label">基础URL</label>
                            <input type="text" class="form-control" id="aiBaseUrl" name="ai_base_url" 
                                   value="{{ ai_base_url }}" placeholder="例如: https://api.deepseek.com">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="aiModel" class="form-label">模型名称</label>
                            <input type="text" class="form-control" id="aiModel" name="ai_model" 
                                   value="{{ ai_model }}" placeholder="例如: deepseek-chat">
                        </div>
                        <div class="col-md-6 mb-3 d-flex align-items-end">
                            <button type="submit" class="btn btn-primary w-100">
                                <i class="bi bi-save me-1"></i>保存AI配置
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- 系统配置 -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-sliders me-2"></i>系统配置
                </h5>
            </div>
            <div class="card-body">
                <form id="systemConfigForm" method="post" action="/api/update_config">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="sendReportSwitch" 
                                       name="send_report_to_source" {% if send_report_to_source %}checked{% endif %}>
                                <label class="form-check-label" for="sendReportSwitch">
                                    将报告发送回源频道
                                </label>
                            </div>
                            <div class="form-text">
                                当前配置: {{ "启用" if send_report_to_source else "禁用" }}
                            </div>
                        </div>
                        <div class="col-md-6 mb-3 d-flex align-items-end">
                            <button type="submit" class="btn btn-primary w-100">
                                <i class="bi bi-save me-1"></i>保存系统配置
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- 当前配置信息 -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-info-square me-2"></i>当前配置信息
                </h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-bordered">
                        <tbody>
                            <tr>
                                <th style="width: 30%">频道数量</th>
                                <td>{{ channels|length }}</td>
                            </tr>
                            <tr>
                                <th>AI模型</th>
                                <td>{{ ai_model }}</td>
                            </tr>
                            <tr>
                                <th>基础URL</th>
                                <td>{{ ai_base_url }}</td>
                            </tr>
                            <tr>
                                <th>报告发送到源频道</th>
                                <td>{{ "是" if send_report_to_source else "否" }}</td>
                            </tr>
                            <tr>
                                <th>配置文件路径</th>
                                <td>config.json</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// 初始化表单提交
document.addEventListener('DOMContentLoaded', function() {
    const aiConfigForm = document.getElementById('aiConfigForm');
    if (aiConfigForm) {
        aiConfigForm.addEventListener('submit', function(event) {
            event.preventDefault();
            updateAiConfig();
        });
    }
    
    const systemConfigForm = document.getElementById('systemConfigForm');
    if (systemConfigForm) {
        systemConfigForm.addEventListener('submit', function(event) {
            event.preventDefault();
            updateSystemConfig();
        });
    }
});

// 更新AI配置
function updateAiConfig() {
    const formData = new FormData(document.getElementById('aiConfigForm'));
    
    // 当只更新AI配置时，也需要包含当前的send_report_to_source状态
    // 获取当前checkbox状态
    const sendReportSwitch = document.getElementById('sendReportSwitch');
    if (sendReportSwitch) {
        // 确保send_report_to_source参数总是被发送
        const value = sendReportSwitch.checked ? 'on' : 'off';
        // 先删除可能存在的旧值（如果有的话）
        if (formData.has('send_report_to_source')) {
            formData.delete('send_report_to_source');
        }
        formData.append('send_report_to_source', value);
    }
    
    fetch('/api/update_config', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            showToast(data.message, 'success');
            
            // 刷新页面
            setTimeout(() => {
                location.reload();
            }, 1000);
        } else {
            showToast(data.message, 'danger');
        }
    })
    .catch(error => {
        console.error('更新配置失败:', error);
        showToast('更新配置失败: ' + error, 'danger');
    });
}

// 更新系统配置
function updateSystemConfig() {
    const formData = new FormData(document.getElementById('systemConfigForm'));
    
    // 确保send_report_to_source参数总是被发送
    // 如果checkbox未选中，手动添加值为"off"
    const sendReportSwitch = document.getElementById('sendReportSwitch');
    if (!sendReportSwitch.checked) {
        // 如果checkbox未选中，确保formData中有send_report_to_source参数
        // 先删除可能存在的旧值（如果有的话）
        if (formData.has('send_report_to_source')) {
            formData.delete('send_report_to_source');
        }
        formData.append('send_report_to_source', 'off');
    }
    
    fetch('/api/update_config', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            showToast(data.message, 'success');
            
            // 刷新页面
            setTimeout(() => {
                location.reload();
            }, 1000);
        } else {
            showToast(data.message, 'danger');
        }
    })
    .catch(error => {
        console.error('更新配置失败:', error);
        showToast('更新配置失败: ' + error, 'danger');
    });
}
</script>
{% endblock %}
