{% extends "base.html" %}

{% block title %}任务管理{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4">
            <i class="bi bi-clock-history me-2"></i>任务管理
        </h1>
    </div>
</div>

<!-- 手动触发总结 -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-play-circle me-2"></i>手动触发总结
                </h5>
            </div>
            <div class="card-body">
                <p class="text-muted mb-3">
                    立即为指定频道生成本周的消息总结报告。此操作将跳过定时任务，立即执行总结。
                </p>
                
                <form id="triggerSummaryForm">
                    <div class="row">
                        <div class="col-md-8 mb-3">
                            <label for="triggerChannel" class="form-label">选择频道</label>
                            <select class="form-select" id="triggerChannel" name="channel" required>
                                <option value="">请选择频道...</option>
                                {% for channel in channels %}
                                <option value="{{ channel }}">{{ channel }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-4 mb-3 d-flex align-items-end">
                            <button type="submit" class="btn btn-primary w-100">
                                <i class="bi bi-play-fill me-1"></i>立即总结
                            </button>
                        </div>
                    </div>
                </form>
                
                <div id="triggerResult" class="mt-3" style="display: none;">
                    <!-- 结果将在这里显示 -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 定时任务列表 -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="bi bi-calendar-event me-2"></i>定时任务列表
                </h5>
                <button class="btn btn-outline-secondary btn-sm" onclick="refreshTasks()">
                    <i class="bi bi-arrow-clockwise"></i> 刷新
                </button>
            </div>
            <div class="card-body">
                {% if channels %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>频道</th>
                                <th>总结时间</th>
                                <th>状态</th>
                                <th>下次执行</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for channel in channels %}
                            <tr>
                                <td>{{ loop.index }}</td>
                                <td>
                                    <code>{{ channel }}</code>
                                </td>
                                <td>
                                    {% if channel in summary_schedules %}
                                        {% set schedule = summary_schedules[channel] %}
                                        {% set day_map = {'mon': '周一', 'tue': '周二', 'wed': '周三', 'thu': '周四', 'fri': '周五', 'sat': '周六', 'sun': '周日'} %}
                                        <span class="badge bg-info">{{ day_map.get(schedule.day, schedule.day) }}</span>
                                        <span class="badge bg-primary ms-1">{{ "%02d:%02d"|format(schedule.hour, schedule.minute) }}</span>
                                    {% else %}
                                        <span class="badge bg-secondary">默认时间（周一 09:00）</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <span class="badge bg-success">已启用</span>
                                </td>
                                <td>
                                    <span class="next-execution" data-channel="{{ channel }}" 
                                          data-day="{{ summary_schedules[channel].day if channel in summary_schedules else 'mon' }}" 
                                          data-hour="{{ summary_schedules[channel].hour if channel in summary_schedules else 9 }}" 
                                          data-minute="{{ summary_schedules[channel].minute if channel in summary_schedules else 0 }}">
                                        计算中...
                                    </span>
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm" role="group">
                                        <button class="btn btn-outline-primary" onclick="triggerChannelSummary('{{ channel }}')">
                                            <i class="bi bi-play-fill"></i> 立即执行
                                        </button>
                                        <button class="btn btn-outline-info" data-bs-toggle="modal" data-bs-target="#editScheduleModal" 
                                                data-channel="{{ channel }}">
                                            <i class="bi bi-clock"></i> 修改时间
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-5">
                    <i class="bi bi-calendar-x text-muted" style="font-size: 3rem;"></i>
                    <h5 class="mt-3 text-muted">暂无定时任务</h5>
                    <p class="text-muted">请先在频道管理页面添加频道</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- 任务执行历史 -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="bi bi-history me-2"></i>最近执行记录
                </h5>
                <button class="btn btn-outline-secondary btn-sm" onclick="refreshTaskHistory()">
                    <i class="bi bi-arrow-clockwise"></i> 刷新
                </button>
            </div>
            <div class="card-body">
                {% if recent_tasks %}
                <div class="table-responsive">
                    <table class="table table-sm table-hover">
                        <thead>
                            <tr>
                                <th>时间</th>
                                <th>频道</th>
                                <th>类型</th>
                                <th>状态</th>
                                <th>结果</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for task in recent_tasks|reverse %}
                            <tr>
                                <td>
                                    <small>{{ task.timestamp.strftime('%H:%M:%S') }}</small>
                                    <br>
                                    <small class="text-muted">{{ task.timestamp.strftime('%m-%d') }}</small>
                                </td>
                                <td>
                                    <code class="small">{{ task.channel|truncate(20) }}</code>
                                </td>
                                <td>
                                    <span class="badge {% if task.task_type == '手动触发总结' %}bg-primary{% elif task.task_type == '定时任务' %}bg-info{% else %}bg-secondary{% endif %}">
                                        {{ task.task_type }}
                                    </span>
                                </td>
                                <td>
                                    {% if task.status == '成功' or task.status == '已触发' %}
                                    <span class="badge bg-success">{{ task.status }}</span>
                                    {% elif task.status == '失败' %}
                                    <span class="badge bg-danger">{{ task.status }}</span>
                                    {% elif task.status == '执行中' %}
                                    <span class="badge bg-warning">{{ task.status }}</span>
                                    {% else %}
                                    <span class="badge bg-secondary">{{ task.status }}</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <small>{{ task.result|truncate(30) }}</small>
                                    {% if task.result|length > 30 %}
                                    <button class="btn btn-link btn-sm p-0 ms-1" onclick="showTaskDetails('{{ loop.index }}')" title="查看详情">
                                        <i class="bi bi-eye"></i>
                                    </button>
                                    <div id="task-details-{{ loop.index }}" class="d-none">
                                        {{ task.result }}
                                    </div>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-5">
                    <i class="bi bi-clock-history text-muted" style="font-size: 3rem;"></i>
                    <h5 class="mt-3 text-muted">暂无执行记录</h5>
                    <p class="text-muted">手动触发总结任务后，执行记录将显示在这里</p>
                </div>
                {% endif %}
                
                <div class="mt-3">
                    <small class="text-muted">
                        <i class="bi bi-info-circle me-1"></i>
                        显示最近 {{ recent_tasks|length if recent_tasks else 0 }} 条执行记录
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 编辑时间配置模态框（复用频道管理的模态框） -->
<div class="modal fade" id="editScheduleModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-clock me-2"></i>修改总结时间
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="editScheduleForm" method="post" action="/api/set_schedule">
                <div class="modal-body">
                    <input type="hidden" id="editChannel" name="channel">
                    
                    <div class="mb-3">
                        <label class="form-label">频道</label>
                        <div class="form-control" id="channelDisplay"></div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="scheduleDay" class="form-label">星期几</label>
                            <select class="form-select" id="scheduleDay" name="day" required>
                                <option value="mon">周一</option>
                                <option value="tue">周二</option>
                                <option value="wed">周三</option>
                                <option value="thu">周四</option>
                                <option value="fri">周五</option>
                                <option value="sat">周六</option>
                                <option value="sun">周日</option>
                            </select>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="scheduleHour" class="form-label">小时 (0-23)</label>
                            <input type="number" class="form-control" id="scheduleHour" name="hour" 
                                   min="0" max="23" value="9" required>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="scheduleMinute" class="form-label">分钟 (0-59)</label>
                            <input type="number" class="form-control" id="scheduleMinute" name="minute" 
                                   min="0" max="59" value="0" required>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="submit" class="btn btn-primary">保存</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// 初始化模态框事件
document.addEventListener('DOMContentLoaded', function() {
    // 编辑时间配置模态框
    const editScheduleModal = document.getElementById('editScheduleModal');
    if (editScheduleModal) {
        editScheduleModal.addEventListener('show.bs.modal', function(event) {
            const button = event.relatedTarget;
            const channel = button.getAttribute('data-channel');
            
            document.getElementById('editChannel').value = channel;
            document.getElementById('channelDisplay').textContent = channel;
        });
    }
    
    // 手动触发总结表单
    const triggerSummaryForm = document.getElementById('triggerSummaryForm');
    if (triggerSummaryForm) {
        triggerSummaryForm.addEventListener('submit', function(event) {
            event.preventDefault();
            triggerSummary();
        });
    }
    
    // 编辑时间配置表单
    const editScheduleForm = document.getElementById('editScheduleForm');
    if (editScheduleForm) {
        editScheduleForm.addEventListener('submit', function(event) {
            event.preventDefault();
            saveSchedule();
        });
    }
});

// 手动触发总结
function triggerSummary() {
    const channel = document.getElementById('triggerChannel').value;
    
    if (!channel) {
        showToast('请选择频道', 'warning');
        return;
    }
    
    // 显示加载状态
    const resultDiv = document.getElementById('triggerResult');
    resultDiv.innerHTML = `
        <div class="alert alert-info">
            <div class="d-flex align-items-center">
                <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                <div>正在为频道 ${channel} 生成总结报告...</div>
            </div>
        </div>
    `;
    resultDiv.style.display = 'block';
    
    // 发送AJAX请求到服务器
    const formData = new FormData();
    formData.append('channel', channel);
    
    fetch('/api/trigger_summary', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            resultDiv.innerHTML = `
                <div class="alert alert-success">
                    <i class="bi bi-check-circle-fill me-2"></i>
                    ${data.message}
                    <div class="mt-2">
                        <small class="text-muted">任务已提交，请查看机器人消息获取结果。</small>
                    </div>
                </div>
            `;
            showToast('总结任务已触发', 'success');
        } else {
            resultDiv.innerHTML = `
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i>
                    ${data.message}
                </div>
            `;
            showToast('触发失败: ' + data.message, 'danger');
        }
    })
    .catch(error => {
        console.error('触发总结失败:', error);
        resultDiv.innerHTML = `
            <div class="alert alert-danger">
                <i class="bi bi-exclamation-triangle-fill me-2"></i>
                触发总结失败: ${error}
            </div>
        `;
        showToast('触发总结失败: ' + error, 'danger');
    });
}

// 为单个频道触发总结
function triggerChannelSummary(channel) {
    if (confirm(`确定要立即为频道 "${channel}" 生成总结报告吗？`)) {
        // 发送AJAX请求到服务器
        const formData = new FormData();
        formData.append('channel', channel);
        
        fetch('/api/trigger_summary', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                showToast(data.message, 'success');
            } else {
                showToast('触发失败: ' + data.message, 'danger');
            }
        })
        .catch(error => {
            console.error('触发总结失败:', error);
            showToast('触发总结失败: ' + error, 'danger');
        });
    }
}

// 保存时间配置
function saveSchedule() {
    const channel = document.getElementById('editChannel').value;
    const day = document.getElementById('scheduleDay').value;
    const hour = parseInt(document.getElementById('scheduleHour').value);
    const minute = parseInt(document.getElementById('scheduleMinute').value);
    
    // 发送AJAX请求到服务器
    const formData = new FormData();
    formData.append('channel', channel);
    formData.append('day', day);
    formData.append('hour', hour);
    formData.append('minute', minute);
    
    fetch('/api/set_schedule', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            showToast(data.message, 'success');
            $('#editScheduleModal').modal('hide');
            
            // 刷新页面
            setTimeout(() => {
                location.reload();
            }, 1000);
        } else {
            showToast(data.message, 'danger');
        }
    })
    .catch(error => {
        console.error('保存时间配置失败:', error);
        showToast('保存时间配置失败: ' + error, 'danger');
    });
}

// 刷新任务列表
function refreshTasks() {
    showToast('正在刷新任务列表...', 'info');
    setTimeout(() => {
        location.reload();
    }, 500);
}

// 计算下次执行时间
function calculateNextExecution(day, hour, minute) {
    // 星期几映射到JavaScript的getDay()返回值
    const dayMap = {
        'sun': 0, // 周日
        'mon': 1, // 周一
        'tue': 2, // 周二
        'wed': 3, // 周三
        'thu': 4, // 周四
        'fri': 5, // 周五
        'sat': 6  // 周六
    };
    
    const now = new Date();
    const currentDay = now.getDay(); // 0=周日, 1=周一, ..., 6=周六
    const currentHour = now.getHours();
    const currentMinute = now.getMinutes();
    const currentSecond = now.getSeconds();
    
    const targetDay = dayMap[day] !== undefined ? dayMap[day] : 1; // 默认为周一
    const targetHour = parseInt(hour) || 9;
    const targetMinute = parseInt(minute) || 0;
    
    // 计算距离目标星期几还有几天
    let daysToAdd = targetDay - currentDay;
    if (daysToAdd < 0) {
        daysToAdd += 7; // 如果目标日已经过去，就等到下周
    }
    
    // 创建目标时间
    const targetDate = new Date(now);
    targetDate.setDate(now.getDate() + daysToAdd);
    targetDate.setHours(targetHour, targetMinute, 0, 0);
    
    // 如果今天就是目标日，但时间已经过去，就等到下周
    if (daysToAdd === 0) {
        const currentTime = currentHour * 3600 + currentMinute * 60 + currentSecond;
        const targetTime = targetHour * 3600 + targetMinute * 60;
        if (currentTime >= targetTime) {
            targetDate.setDate(targetDate.getDate() + 7);
        }
    }
    
    return targetDate;
}

// 格式化日期显示
function formatNextExecution(date) {
    const now = new Date();
    const diffMs = date - now;
    const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
    const diffHours = Math.floor((diffMs % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
    const diffMinutes = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
    
    if (diffDays > 0) {
        return `${diffDays}天${diffHours}小时后`;
    } else if (diffHours > 0) {
        return `${diffHours}小时${diffMinutes}分钟后`;
    } else if (diffMinutes > 0) {
        return `${diffMinutes}分钟后`;
    } else {
        return "即将执行";
    }
}

// 更新所有频道的下次执行时间
function updateNextExecutionTimes() {
    const elements = document.querySelectorAll('.next-execution');
    elements.forEach(element => {
        const day = element.getAttribute('data-day');
        const hour = element.getAttribute('data-hour');
        const minute = element.getAttribute('data-minute');
        
        const nextDate = calculateNextExecution(day, hour, minute);
        const formattedTime = formatNextExecution(nextDate);
        
        // 同时显示具体日期和时间
        const dateStr = nextDate.toLocaleDateString('zh-CN', { 
            weekday: 'long',
            month: 'long',
            day: 'numeric'
        });
        const timeStr = nextDate.toLocaleTimeString('zh-CN', {
            hour: '2-digit',
            minute: '2-digit'
        });
        
        element.innerHTML = `
            <span class="text-primary">${formattedTime}</span>
            <br>
            <small class="text-muted">${dateStr} ${timeStr}</small>
        `;
        element.title = `具体时间: ${dateStr} ${timeStr}`;
    });
}

// 页面加载完成后计算下次执行时间
document.addEventListener('DOMContentLoaded', function() {
    // 初始化模态框事件
    const editScheduleModal = document.getElementById('editScheduleModal');
    if (editScheduleModal) {
        editScheduleModal.addEventListener('show.bs.modal', function(event) {
            const button = event.relatedTarget;
            const channel = button.getAttribute('data-channel');
            
            document.getElementById('editChannel').value = channel;
            document.getElementById('channelDisplay').textContent = channel;
        });
    }
    
    // 手动触发总结表单
    const triggerSummaryForm = document.getElementById('triggerSummaryForm');
    if (triggerSummaryForm) {
        triggerSummaryForm.addEventListener('submit', function(event) {
            event.preventDefault();
            triggerSummary();
        });
    }
    
    // 编辑时间配置表单
    const editScheduleForm = document.getElementById('editScheduleForm');
    if (editScheduleForm) {
        editScheduleForm.addEventListener('submit', function(event) {
            event.preventDefault();
            saveSchedule();
        });
    }
    
    // 计算下次执行时间
    updateNextExecutionTimes();
    
    // 每分钟更新一次时间
    setInterval(updateNextExecutionTimes, 60000);
});

// 刷新任务历史记录
function refreshTaskHistory() {
    showToast('正在刷新任务历史记录...', 'info');
    setTimeout(() => {
        location.reload();
    }, 500);
}

// 显示任务详情
function showTaskDetails(taskIndex) {
    const detailsDiv = document.getElementById(`task-details-${taskIndex}`);
    if (detailsDiv) {
        const details = detailsDiv.textContent;
        // 使用Bootstrap模态框显示详情
        const modalHtml = `
            <div class="modal fade" id="taskDetailsModal" tabindex="-1">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">任务执行详情</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <pre class="bg-light p-3 rounded" style="max-height: 400px; overflow-y: auto;">${details}</pre>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // 移除现有的模态框
        const existingModal = document.getElementById('taskDetailsModal');
        if (existingModal) {
            existingModal.remove();
        }
        
        // 添加新的模态框
        document.body.insertAdjacentHTML('beforeend', modalHtml);
        
        // 显示模态框
        const modal = new bootstrap.Modal(document.getElementById('taskDetailsModal'));
        modal.show();
    }
}

// 显示Toast通知
function showToast(message, type = 'info') {
    const toastContainer = document.getElementById('toastContainer');
    if (!toastContainer) {
        // 创建Toast容器
        const container = document.createElement('div');
        container.id = 'toastContainer';
        container.className = 'toast-container position-fixed bottom-0 end-0 p-3';
        document.body.appendChild(container);
    }
    
    const toastId = 'toast-' + Date.now();
    const toast = document.createElement('div');
    toast.id = toastId;
    toast.className = `toast align-items-center text-bg-${type} border-0`;
    toast.setAttribute('role', 'alert');
    toast.setAttribute('aria-live', 'assertive');
    toast.setAttribute('aria-atomic', 'true');
    
    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">
                ${message}
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    `;
    
    document.getElementById('toastContainer').appendChild(toast);
    
    const bsToast = new bootstrap.Toast(toast, { delay: 3000 });
    bsToast.show();
    
    // 自动移除
    toast.addEventListener('hidden.bs.toast', function () {
        toast.remove();
    });
}
</script>
{% endblock %}