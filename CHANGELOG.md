# 更新日志

所有对项目的显著更改都将记录在此文件中。

格式基于 [Keep a Changelog](https://keepachangelog.com/zh-CN/1.0.0/)，
并且本项目遵循 [语义化版本](https://semver.org/lang/zh-CN/)。

## [1.2.7] - 2026-01-13

### 新增
- **频道级投票配置功能**：为每个频道单独配置投票的发送位置和行为
  - **频道模式**：投票直接发送到频道，回复总结消息
  - **讨论组模式**：投票发送到频道讨论组，回复转发消息（默认，保持向后兼容）
  - 支持为每个频道单独启用或禁用投票功能
  - 支持通过配置文件或命令进行配置

### 新增命令
- `/channelpoll <频道>` - 查看指定频道或所有频道的投票配置
  - 不带参数：显示所有频道的投票配置
  - 带频道参数：显示指定频道的详细配置
- `/setchannelpoll <频道> <enabled> <location>` - 设置频道投票配置
  - `enabled`: true/false（启用/禁用投票）
  - `location`: channel/discussion（频道/讨论组）
  - 示例：`/setchannelpoll channel1 true channel` - 启用并发送到频道
  - 示例：`/setchannelpoll channel1 false discussion` - 禁用投票
- `/deletechannelpoll <频道>` - 删除频道投票配置，恢复全局配置
  - 删除后频道将使用全局 `ENABLE_POLL` 配置
  - 默认使用讨论组模式

### 配置文件增强
- **config.json** 新增 `channel_poll_settings` 字段：
  ```json
  {
    "channel_poll_settings": {
      "https://t.me/channel1": {
        "enabled": true,
        "send_to_channel": true
      },
      "https://t.me/channel2": {
        "enabled": true,
        "send_to_channel": false
      }
    }
  }
  ```
- 支持为每个频道配置独立的投票行为
- 未配置的频道自动使用全局配置，保持向后兼容

### 技术实现
- **config.py** 新增函数：
  - `get_channel_poll_config(channel)` - 获取频道投票配置
  - `set_channel_poll_config(channel, enabled, send_to_channel)` - 设置频道投票配置
  - `delete_channel_poll_config(channel)` - 删除频道投票配置
  - 新增 `CHANNEL_POLL_SETTINGS` 全局变量
- **telegram_client.py** 重构投票发送逻辑：
  - 新增 `send_poll_to_channel()` - 频道模式投票发送
  - 新增 `send_poll()` - 根据配置统一入口
  - 保留 `send_poll_to_discussion_group()` - 讨论组模式投票发送
  - 更新 `send_report()` 使用新的投票发送接口
- **command_handlers.py** 新增命令处理：
  - `handle_show_channel_poll()` - 查看投票配置
  - `handle_set_channel_poll()` - 设置投票配置
  - `handle_delete_channel_poll()` - 删除投票配置
- **main.py** 注册新命令和更新启动消息

### 文档更新
- 新增 `POLL_FEATURE.md` 文档，详细说明投票配置功能
- 新增 `config.example.json` 配置示例文件
- 更新 `README.md`，添加投票配置说明和使用示例
- 更新命令列表，添加三个新投票配置命令

### 向后兼容
- 未配置的频道默认使用讨论组模式（原有行为）
- 未配置启用状态的频道使用全局 `ENABLE_POLL` 配置
- 现有配置无需修改即可继续使用
- 所有现有功能保持不变

### 使用场景
- **公开频道**：使用讨论组模式，投票在评论区进行
- **私有频道**：使用频道模式，投票直接在频道中
- **混合配置**：不同频道使用不同的投票策略

## [1.2.6] - 2026-01-12

### 新增
- **多频率模式支持**：新增"每天"和"每周N天"两种自动总结频率模式
  - **每天模式 (daily)**：每天在固定时间执行总结，如每天23:00
  - **每周N天模式 (weekly)**：每周在指定的多天执行，如每周一和周四
  - 支持为每个频道单独配置不同的总结频率
  - 报告标题根据频率自动显示"日报"或"周报"
  - 配置数据结构扩展支持 `frequency` 和 `days` 字段

### 命令增强
- `/setchannelschedule` 命令支持新格式：
  - `/setchannelschedule <频道> daily <小时> <分钟>` - 设置每天总结
  - `/setchannelschedule <频道> weekly <星期,星期> <小时> <分钟>` - 设置每周多天总结
  - 支持多天格式：`mon,thu` 表示周一和周四
- `/showchannelschedule` 命令优化显示格式：
  - 清晰展示"每天"或"每周N天"模式
  - 使用中文显示星期几（周一、周二等）
  - 支持查看所有频道或指定频道的配置

### 向后兼容
- 保留旧命令格式 `/setchannelschedule <频道> <星期> <小时> <分钟>`
- 旧格式配置自动识别并转换为新格式
- 无需修改现有配置即可继续使用
- 现有调度任务不受影响

### 技术实现
- **config.py** 新增函数：
  - `normalize_schedule_config()` - 配置标准化，处理向后兼容
  - `validate_schedule_v2()` - 新格式验证
  - `set_channel_schedule_v2()` - 新格式设置
  - `build_cron_trigger()` - 构建 cron 触发器参数
- **main.py** 更新调度器初始化逻辑：
  - 使用 `build_cron_trigger()` 构建触发器
  - 支持每天的 `day_of_week='*'` 参数
  - 支持每周多天的 `day_of_week='mon,thu'` 参数
- **command_handlers.py** 更新命令处理：
  - 添加 `format_schedule_info()` 辅助函数
  - 支持新旧格式的命令解析
  - 更新手动总结标题生成逻辑
- **scheduler.py** 更新报告标题生成：
  - 根据频率模式生成"日报"或"周报"标题
  - 日报标题格式：`频道名 日报 M.D`
  - 周报标题格式：`频道名 周报 M.D-M.D`

### 配置示例
```json
{
  "summary_schedules": {
    "https://t.me/DailyChannel": {
      "frequency": "daily",
      "hour": 23,
      "minute": 0
    },
    "https://t.me/WeeklyChannel": {
      "frequency": "weekly",
      "days": ["mon", "thu"],
      "hour": 14,
      "minute": 30
    },
    "https://t.me/LegacyChannel": {
      "day": "sun",
      "hour": 23,
      "minute": 0
    }
  }
}
```

## [1.2.5] - 2026-01-12

### 移除
- **完全移除Web管理界面**：移除了整个Web管理界面及相关功能
  - 删除了`web_app.py`文件及其所有FastAPI路由和API端点
  - 删除了`templates/`目录（所有HTML模板文件）
  - 删除了`static/`目录（CSS和JavaScript文件）
  - 从`main.py`中移除了Web服务器启动代码和相关线程
  - 移除了Web管理界面触发的总结任务队列处理逻辑
  - 从`requirements.txt`中移除了Web相关依赖（fastapi、uvicorn、jinja2、python-multipart、itsdangerous）
  - 从`config.py`中移除了`WEB_PORT`配置项和相关日志
  - 从`.env.example`中移除了Web管理界面配置示例
  - 从`docker-compose.yml`中移除了Web端口映射、健康检查和资源限制相关配置

### 简化
- **简化架构**：项目现在完全依赖Telegram命令进行管理，架构更加简洁
  - 所有功能通过Telegram机器人命令操作
  - 减少了依赖项和代码复杂度
  - 降低了资源使用（内存限制从768M降至512M）
  - 简化了部署流程

### 文档更新
- 更新了README.md，移除了所有Web管理界面相关的说明和配置示例
- 更新了项目结构说明，移除了Web相关文件和目录的描述

## [1.2.4] - 2026-01-11

### 修复
- **消息过度分割问题**：修复了智能分割算法导致消息被过度分割的问题
  - 修改`telegram_client_utils.py`中的`split_message_smart`函数
  - 移除了在每个换行符处分割的逻辑
  - 只在段落边界（连续两个或更多换行符）和句子边界（句号、问号、感叹号后）分割
  - 添加最小分段长度检查（100字符），避免产生过短的段落
  - 改进分割策略：当找到的分割点会导致分段太短时，会继续查找更远的合理分割点
  - 7554字符的列表式内容从94段（平均80字符/段）优化为2-3段（接近4000字符/段）

### 修改
- **完全移除分段标题**：优化了长消息分段的显示方式
  - 修改`telegram_client.py`中的`send_long_message`和`send_report`函数
  - 移除所有分段消息的标题显示，包括第一条消息
  - 不再显示"📋 **频道名称**"或"1/3"、"2/3"等分页信息
  - 直接发送原始内容，提供更简洁的阅读体验
  - 通过`show_pagination=False`参数控制是否显示分页标题

- **/changelog命令改为直接发送文件**：优化了/changelog命令的实现方式
  - 改为直接发送CHANGELOG.md文件，不再进行任何切割和分段
  - 使用`send_file()`方法发送完整文件，用户可下载查看
  - 简化代码逻辑，提高可维护性
  - 完全避免消息分段问题
  - 保持原始markdown格式完整性

### 影响
- 长消息分段更加合理，充分利用Telegram 4000字符的消息限制
- 分段消息显示更加简洁，没有任何额外的标题或分页标记
- `/changelog`命令现在发送文件而非文本消息
- 用户可以下载并保存完整的变更日志
- 列表式内容不再被过度分割成大量短段落

## [1.2.3] - 2026-01-11

### 修复
- **/changelog命令过度分段问题**：修复了/changelog命令导致消息被分割成几百条的问题
  - 修改默认行为，只显示最近1个版本的更新日志
  - 支持参数控制显示的版本数量：/changelog 5 显示最近5个版本
  - 优化send_long_message函数，新增show_pagination参数
  - 当show_pagination=False时，只在第一条消息显示标题，后续消息直接发送内容
  - 大幅减少消息数量，提供更好的用户体验

### 改进
- **消息分段优化**：改进长消息的分段策略
  - 避免每条消息都显示分页标题浪费字符空间
  - 第一条消息显示完整标题，后续消息无标题
  - 充分利用Telegram 4000字符的消息限制

### 使用方式
- `/changelog` - 显示最近1个版本（默认）
- `/changelog 5` - 显示最近5个版本
- `/changelog 14` - 显示全部14个版本

## [1.2.2] - 2026-01-11

### 新增
- **自动置顶总结消息**：当在频道中发送了总结消息后，自动将其置顶
  - 在`send_report`函数中添加自动置顶功能
  - 使用`client.pin_message()`方法置顶第一条消息
  - 添加错误处理，即使置顶失败（如权限不足）也不会影响主要功能
  - 在两个发送路径（使用现有客户端和创建新客户端）中都应用置顶功能

### 修复
- **总结消息标题优化**：修正总结消息的标题不使用从频道链接中提取，而使用频道的实际名称
  - 在`command_handlers.py`的`handle_manual_summary`函数中，使用`client.get_entity(channel).title`获取频道实际名称
  - 在`telegram_client.py`的`send_report`函数中，添加智能标题检查逻辑，避免重复标题
  - 统一管理员和源频道接收的总结标题，确保两者都使用频道实际名称
  - 改进标题替换逻辑，避免内容被截断

### 技术实现
- **频道实体获取**：使用`client.get_entity(source_channel)`获取频道实体，提取实际名称
- **智能标题检查**：检查总结文本是否已有标题，避免重复添加
- **条件性更新**：只有当标题与频道实际名称不匹配时才更新标题
- **错误回退**：获取频道实体失败时，使用频道链接的最后部分作为回退名称
- **日期范围提取**：从原总结文本中提取日期范围，保持格式一致

### 影响范围
- 所有总结消息发送功能：
  - `/summary`命令的手动总结
  - 自动周报的定时总结
  - 所有发送到源频道的总结消息都会自动置顶
  - 所有总结消息都使用频道实际名称作为标题

## [1.2.1] - 2026-01-11

### 修复
- **EntityBoundsInvalidError错误**：修复了发送长消息分段时出现的`EntityBoundsInvalidError: Some of provided entities have invalid bounds`错误
  - 创建智能消息分割算法 (`telegram_client_utils.py`)，保护Markdown格式实体不被破坏
  - 更新`send_long_message()`函数使用智能分割，确保**粗体**、`内联代码`、[链接]等实体完整性
  - 添加实体完整性验证和自动修复机制，当格式被破坏时自动移除格式重试
  - 优先在段落、句子、换行等自然边界分割，避免破坏消息结构
  - 提供优雅的回退机制：智能分割失败时自动使用简单字符分割

### 技术实现
- **智能分割算法**：实现`split_message_smart()`函数，能够识别和保护Markdown实体
- **实体保护**：确保**粗体**、`代码`、[链接]等Markdown实体不被分割破坏
- **边界检测**：优先在自然边界（段落、句子）分割，其次在单词边界分割
- **验证机制**：每个分段都验证实体完整性和长度限制
- **错误恢复**：发送失败时自动尝试移除格式重试，确保消息能够送达

### 影响范围
- 修复影响所有长消息发送功能：
  - `/summary`命令的长消息发送
  - 自动周报的长消息发送
  - `/changelog`命令的更新日志发送
  - 所有使用`send_long_message()`或`send_report()`的地方

### 测试验证
- 通过全面的单元测试、集成测试和演示测试验证修复效果
- 100%成功率，所有分段符合Telegram要求且实体完整
- 彻底解决了`EntityBoundsInvalidError`错误，提高了消息发送的可靠性

## [1.2.0] - 2026-01-10

### 新增
- **投票消息功能**：当总结消息发送至源频道时，自动生成投票消息并发送到讨论组评论区
  - AI根据总结内容智能生成相关投票问题
  - 自动检测频道绑定的讨论组（linked_chat_id）
  - 支持Telegram投票长度限制（问题255字符，选项100字符）
  - 自动清理投票文本，移除不可见字符
  - 支持被动监听转发消息机制，避免机器人权限限制
  - 提供配置开关，可通过`ENABLE_POLL`环境变量控制功能开关

### 技术实现
- **底层RPC调用**：直接使用Telethon底层`SendMediaRequest`，绕过高级函数转换问题
- **正确对象包装**：使用`TextWithEntities`包装投票文本，`InputReplyToMessage`包装回复ID
- **智能ID转换**：自动将讨论组ID转换为Telethon超级群组格式（-100xxxxxxxxx）
- **多级错误处理**：投票失败不影响主要总结流程，记录详细错误日志
- **容错机制**：转发消息超时（10秒）后发送独立投票消息作为备选方案

### 配置
- 在`config.py`中添加`ENABLE_POLL`配置项，默认值为`True`
- 在`.env.example`中添加`ENABLE_POLL=True`配置示例
- 支持通过环境变量或配置文件控制投票功能开关

### 使用方式
1. **自动触发**：执行`/summary`命令时，如果频道绑定了讨论组且启用了投票功能，会自动发送投票
2. **手动控制**：通过设置`ENABLE_POLL=False`可禁用投票功能
3. **权限要求**：机器人需要加入频道的讨论组（私人群组）才能发送投票

## [1.1.6] - 2026-01-10

### 修复
- **sys模块导入缺失**：修复了`main.py`中处理关机标记时缺少`import sys`导致的`NameError: name 'sys' is not defined`错误
  - 在`main.py`文件开头添加`import sys`语句
  - 确保`sys.exit(0)`能正常执行，避免机器人启动时因遗留关机标记文件而崩溃
- **关机标记文件遗留问题**：修复了Web管理界面关机操作遗留`.shutdown_flag`文件的问题
  - 在`web_app.py`的`api_shutdown_bot`函数中添加关机标记文件清理逻辑
  - 在`main.py`的关机标记处理中添加异常情况下的文件清理
  - 双重保障确保关机标记文件不会遗留
- **Web管理界面关机功能**：修复了Web管理界面关机操作不执行实际关机的问题
  - 修改`web_app.py`中的`api_shutdown_bot`函数，使用后台线程延迟执行关机
  - 先返回成功响应给客户端，然后在后台执行`os._exit(0)`关机
  - 避免FastAPI捕获`SystemExit`异常导致500错误
  - 保持关机标记文件`.shutdown_flag`创建，供主程序检测
- **主程序关机检测**：修复了`main.py`中关机标记文件检测逻辑缺失的问题
  - 添加对`.shutdown_flag`文件的检测和处理
  - 检测到关机标记时向所有管理员发送关机通知
  - 删除关机标记文件后执行`sys.exit(0)`关机

### 改进
- **优雅关机机制**：实现双重关机机制确保可靠性
  - Web服务器通过`os._exit(0)`立即终止
  - 主程序通过检测关机标记文件执行优雅关机
  - 向所有管理员发送关机通知，确保操作可追溯
- **错误处理**：避免Web关机API返回500错误，提供更好的用户体验
- **状态管理**：正确更新机器人状态为`shutting_down`，确保状态一致性
- **文件清理健壮性**：增强关机标记文件清理逻辑，即使在异常情况下也能确保文件被清理

### 技术特性
- **后台线程关机**：使用守护线程延迟执行关机，确保先返回响应
- **双重关机机制**：Web服务器和主程序协同工作，确保关机可靠执行
- **优雅错误处理**：避免FastAPI异常处理机制干扰关机流程
- **完整的状态跟踪**：从运行状态到关机状态的完整生命周期管理
- **健壮的文件管理**：双重保障确保关机标记文件不会遗留，避免影响下次启动

## [1.1.5] - 2026-01-10

### 新增
- **通过.env配置web管理界面登录密码**：支持通过环境变量自定义web管理界面登录密码
  - 在`.env.example`中添加`WEB_ADMIN_PASSWORD`配置示例
  - 修改`web_app.py`，使用`os.getenv("WEB_ADMIN_PASSWORD", "Sakura")`读取密码
  - 更新`templates/login.html`，移除默认密码提示，改为显示配置说明

### 改进
- **安全性提升**：不再在登录页面显示默认密码，提高系统安全性
- **配置灵活性**：用户可以通过.env文件自定义管理员密码，满足不同部署环境需求
- **向后兼容性**：未设置`WEB_ADMIN_PASSWORD`环境变量时，默认使用密码`"Sakura"`
- **文档更新**：更新README.md中的配置示例，添加`WEB_ADMIN_PASSWORD`配置项说明

### 使用方式
1. **自定义密码**：在.env文件中添加`WEB_ADMIN_PASSWORD=your_secure_password`即可使用自定义密码
2. **默认行为**：未配置时使用默认密码`"Sakura"`
3. **安全性建议**：生产环境建议设置强密码，避免使用默认密码

## [1.1.4] - 2026-01-10

### 新增
- **可自定义的Web管理界面端口**：支持通过.env文件自定义Web管理界面端口
  - 在`.env.example`中添加`WEB_PORT=8000`配置示例
  - 在`config.py`中添加读取`WEB_PORT`环境变量的逻辑，支持默认值8000
  - 支持Docker部署，端口映射自动适配配置的端口
- **多地址访问显示**：Web管理界面启动时显示所有可访问地址
  - 本地访问: http://127.0.0.1:{PORT} 或 http://localhost:{PORT}
  - 所有接口: http://0.0.0.0:{PORT}
  - 局域网访问: http://{LAN_IP}:{PORT}（自动获取本地IP地址）

### 改进
- **Docker配置优化**：更新docker-compose.yml支持可配置端口
  - 端口映射改为可配置：`"${WEB_PORT:-8000}:${WEB_PORT:-8000}"`
  - 环境变量配置：`WEB_PORT=${WEB_PORT:-8000}`
  - 健康检查使用配置的端口而不是硬编码的8000
- **向后兼容性**：未配置`WEB_PORT`时使用默认端口8000，确保现有部署不受影响
- **代码健壮性**：添加获取局域网IP地址的异常处理，无网络连接时优雅降级
- **Web管理界面任务结果增强**：手动触发总结后返回更详细的结果信息
  - 成功时显示：消息数量、总结长度、处理时间等详细信息
  - 失败时显示：错误原因、处理时间等详细信息
  - 支持频道不存在或无法访问的错误检测

### 使用方式
1. **自定义端口**：在.env文件中添加`WEB_PORT=9000`即可使用9000端口
2. **Docker部署**：`WEB_PORT=8080 docker-compose up -d`使用8080端口
3. **默认行为**：未配置时使用8000端口

## [1.1.3] - 2026-01-09

### 新增
- **Docker配置适配Web管理界面**：更新Docker配置以完全支持Web管理界面
  - 添加端口映射：暴露Web管理界面端口8000
  - 添加Web服务环境变量：`WEB_HOST=0.0.0.0`, `WEB_PORT=8000`
  - 更新健康检查：检查Web服务可用性
  - 增加资源限制：内存限制增加到768M以支持Web服务
- **GitHub工作流打包优化**：确保发布包包含所有必要文件
  - 添加static/目录（Web管理界面CSS/JavaScript文件）
  - 添加templates/目录（Web管理界面HTML模板）
  - 添加.env.example文件（环境变量示例）

### 修复
- **Docker Compose语法错误**：修复了健康检查命令的YAML语法错误
- **任务执行结果反馈**：修复了Web管理界面触发总结后任务状态不更新的问题
  - 修改`check_web_summary_tasks`函数，在任务执行完成后更新任务执行记录
  - 任务状态从"已触发"正确更新为"成功"或"失败"

### 改进
- **Docker健康检查**：优化健康检查命令，使用单行Python脚本检查Web服务
- **发布流程**：改进GitHub工作流，确保所有必要文件都被包含在发布包中
- **文档更新**：更新README.md，添加Web管理界面的详细使用说明

### 技术特性
- **完整的容器化支持**：Web管理界面完全支持Docker容器化部署
- **生产就绪配置**：Docker Compose配置包含健康检查、资源限制、日志配置
- **自动化发布**：GitHub工作流自动创建发布并打包所有必要文件
- **多部署方式**：支持本地运行、Docker运行、生产部署

## [1.1.2] - 2026-01-09

### 新增
- **Web管理界面稳定性增强**：改进了Web管理界面的稳定性和可靠性
- **线程间通信机制**：添加了线程安全队列，用于Web管理界面和主线程之间的通信
- **改进的错误处理**：在`send_report`函数中添加了全面的错误处理，防止程序崩溃

### 修复
- **数据库锁定问题**：修复了Web管理界面触发总结时导致的SQLite数据库锁定错误
  - 当Web管理界面需要发送报告时，使用活动的客户端实例而不是创建新实例
  - 避免了多个客户端实例同时访问同一个会话数据库文件
- **身份验证问题**：修复了Web管理界面创建新客户端实例时需要重新身份验证的问题
  - 通过线程间通信机制，让Web管理界面将任务加入队列，由主线程使用活动的客户端实例执行
  - 避免了创建新的客户端实例，从而避免了重新身份验证
- **事件循环冲突问题**：修复了Web管理界面和Telegram客户端之间的事件循环冲突
  - 确保Web管理界面和主Telegram客户端运行在各自的线程中，避免事件循环冲突
- **控制台闪退问题**：修复了Web管理界面触发总结时导致控制台闪退的问题
  - 在`send_report`函数中添加了全面的异常处理，捕获所有可能的错误
  - 即使发生错误，也返回空列表而不是让程序崩溃
- **客户端实例传递问题**：修复了`scheduler.py`中`main_job`函数没有正确传递客户端实例的问题
  - 修改`main_job`函数，让它从`telegram_client`模块获取活动的客户端实例
  - 将活动的客户端实例传递给`send_report`函数，避免创建新实例

### 改进
- **代码健壮性**：增强了`send_report`函数的错误处理能力，确保程序不会崩溃
- **性能优化**：通过使用活动的客户端实例，避免了不必要的客户端创建和身份验证
- **用户体验**：Web管理界面触发总结时提供更清晰的反馈信息
- **系统稳定性**：通过线程间通信机制，确保了Web管理界面和主程序的稳定运行

### 技术特性
- **线程安全队列**：使用Python的`queue.Queue`实现线程间通信
- **客户端实例复用**：通过`get_active_client()`函数获取和复用活动的客户端实例
- **全面的异常处理**：在关键函数中添加了try-catch块，防止未处理的异常导致程序崩溃
- **优雅的错误恢复**：即使发生错误，程序也能继续运行，不会影响其他功能

## [1.1.1] - 2026-01-09

### 修复
- **手动触发总结功能**：修复了Web管理界面中手动触发总结功能没有反应的问题
  - 修复了`send_long_message`函数调用时客户端实例为`None`的问题
  - 改为使用`send_report`函数，它会正确创建Telegram客户端实例
  - 确保总结报告能够正确发送给所有管理员
- **Web界面稳定性**：修复了Web服务器启动时的导入依赖问题
- **JavaScript计算错误**：修复了定时任务页面中下次执行时间计算的JavaScript语法错误

### 改进
- **错误处理**：增强了Web API端点的错误处理，提供更详细的错误信息
- **用户体验**：改进了Web界面的响应消息，提供更清晰的操作反馈
- **代码质量**：优化了Web应用代码结构，提高了可维护性

## [1.1.0] - 2026-01-09

### 新增
- **完整的Web管理界面**：为机器人添加了完整的Web管理界面
  - **仪表板** (`/`)：显示机器人状态、频道数量、系统健康状态、错误统计
  - **频道管理** (`/channels`)：查看、添加、删除频道，设置每个频道的自动总结时间
  - **配置管理** (`/config`)：查看和修改AI配置（API密钥、基础URL、模型）
  - **任务管理** (`/tasks`)：手动触发总结任务，查看定时任务列表，实时计算下次执行时间
  - **日志查看** (`/logs`)：查看系统日志，支持过滤、搜索和统计
  - **系统信息** (`/system`)：显示API凭证、管理员列表、错误统计详情
  - **登录系统**：会话管理，默认密码"Sakura"
- **完整的API端点系统**：
  - 系统管理API：清空错误统计、运行健康检查、运行系统诊断
  - 日志管理API：获取日志、清空日志（自动备份）
  - 功能API：手动触发总结、重启机器人、更新AI配置、频道时间配置管理
- **改进的重启功能**：
  - 实现了真正的自动重启功能，创建重启标记文件并执行重启脚本
  - 改进重启逻辑，只停止当前机器人的进程，不影响其他Python应用
  - 支持"web_admin"标识，重启后向所有管理员发送通知

### 改进
- **定时任务管理**：在任务管理页面添加实时下次执行时间计算功能
- **错误处理**：修复了HealthChecker方法调用错误，使用正确的`run_all_checks()`方法
- **模板系统**：修复了所有模板语法错误，确保所有页面都能正常访问
- **API端点**：添加了所有缺失的API端点，确保Web界面所有功能都能正常工作

### 技术特性
- **完整的导航系统**：7个功能页面，响应式设计
- **实际功能集成**：所有配置更改实时保存到`config.json`
- **认证系统**：会话管理，默认密码"Sakura"
- **重启功能**：精确停止当前进程，启动新进程，发送通知
- **API端点**：支持频道管理、配置更新、任务触发等操作
- **错误处理**：集成现有的错误处理系统
- **与Telegram命令兼容**：通过相同的`config.json`文件同步配置
- **实时时间计算**：定时任务页面实时计算并显示下次执行时间

## [1.0.3] - 2026-01-09

### 新增
- **/changelog 命令**：新增查看更新日志功能
  - 支持 `/changelog` 和 `/更新日志` 两种命令格式
  - 仅管理员可使用，读取并显示 CHANGELOG.md 文件内容
  - 自动处理长消息分割，支持完整的错误处理

### 改进
- **启动消息更新**：将 `/changelog (待实现)` 改为 `/changelog`
- **命令注册**：在机器人命令列表中添加 changelog 命令

## [1.0.2] - 2026-01-09

### 新增
- **错误处理与恢复机制增强**
  - 新增错误处理模块 (error_handler.py)
  - 智能重试机制，支持指数退避
  - 全局错误统计与记录系统
  - 健康检查系统，支持自定义检查
  - 优雅关闭处理，支持信号处理

### 改进
- **Telegram客户端增强**
  - 消息抓取函数添加重试机制
  - 错误隔离，单个频道失败不影响其他频道
  - 改进错误日志记录，包含更多上下文信息

- **AI客户端增强**
  - AI分析函数添加重试机制
  - 统一记录AI分析失败的错误信息
  - 记录AI分析的处理时间

- **系统稳定性提升**
  - 主程序集成错误处理系统
  - 自动注册默认健康检查
  - 设置优雅关闭信号处理程序

### 文档
- 新增错误处理改进文档 (ERROR_HANDLING_IMPROVEMENTS.md)
- 更新README.md中的版本信息和功能说明

## [1.0.1] - 2026-01-09

### 修复
- 修复 GitHub Actions 工作流权限问题
- 修复工作流语法错误
- 修复工作流触发条件
- 改进标签创建逻辑，处理已存在标签的情况
- Ciallo～(∠・ω< )⌒★

## [1.0.0] - 2026-01-07

### 新增
- 初始版本发布
- Telegram频道自动总结机器人核心功能
- 支持多频道管理
- 可配置的自动总结时间
- 自定义提示词功能
- AI配置管理
- 日志级别控制
- 重启功能
- 报告发送回源频道选项

### 技术特性
- 基于Telethon的Telegram机器人
- 使用APScheduler进行定时任务调度
- 支持DeepSeek等AI模型
- 配置文件管理
- Docker容器化支持

## 版本管理说明

### 版本号格式
本项目使用语义化版本控制（SemVer）：
- **主版本号**：不兼容的API修改
- **次版本号**：向下兼容的功能性新增
- **修订号**：向下兼容的问题修正

### 更新日志记录规范
1. 所有更改按类型分组：`新增`、`更改`、`修复`、`移除`
2. 每个版本包含发布日期
3. 重大更改需特别标注
4. 参考链接到相关PR或Issue

### 发布流程
1. 更新此CHANGELOG.md文件
2. 更新main.py中的版本号
3. 提交更改并创建Git tag
4. 推送tag触发GitHub自动发布

---
*此文件自动生成，请勿手动删除*
