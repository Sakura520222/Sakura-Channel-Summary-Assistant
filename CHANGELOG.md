# 更新日志

所有对项目的显著更改都将记录在此文件中。

格式基于 [Keep a Changelog](https://keepachangelog.com/zh-CN/1.0.0/)，
并且本项目遵循 [语义化版本](https://semver.org/lang/zh-CN/)。

## [1.1.3] - 2026-01-09

### 新增
- **Docker配置适配Web管理界面**：更新Docker配置以完全支持Web管理界面
  - 添加端口映射：暴露Web管理界面端口8000
  - 添加Web服务环境变量：`WEB_HOST=0.0.0.0`, `WEB_PORT=8000`
  - 更新健康检查：检查Web服务可用性
  - 增加资源限制：内存限制增加到768M以支持Web服务
- **GitHub工作流打包优化**：确保发布包包含所有必要文件
  - 添加static/目录（Web管理界面CSS/JavaScript文件）
  - 添加templates/目录（Web管理界面HTML模板）
  - 添加.env.example文件（环境变量示例）

### 修复
- **Docker Compose语法错误**：修复了健康检查命令的YAML语法错误
- **任务执行结果反馈**：修复了Web管理界面触发总结后任务状态不更新的问题
  - 修改`check_web_summary_tasks`函数，在任务执行完成后更新任务执行记录
  - 任务状态从"已触发"正确更新为"成功"或"失败"

### 改进
- **Docker健康检查**：优化健康检查命令，使用单行Python脚本检查Web服务
- **发布流程**：改进GitHub工作流，确保所有必要文件都被包含在发布包中
- **文档更新**：更新README.md，添加Web管理界面的详细使用说明

### 技术特性
- **完整的容器化支持**：Web管理界面完全支持Docker容器化部署
- **生产就绪配置**：Docker Compose配置包含健康检查、资源限制、日志配置
- **自动化发布**：GitHub工作流自动创建发布并打包所有必要文件
- **多部署方式**：支持本地运行、Docker运行、生产部署

## [1.1.2] - 2026-01-09

### 新增
- **Web管理界面稳定性增强**：改进了Web管理界面的稳定性和可靠性
- **线程间通信机制**：添加了线程安全队列，用于Web管理界面和主线程之间的通信
- **改进的错误处理**：在`send_report`函数中添加了全面的错误处理，防止程序崩溃

### 修复
- **数据库锁定问题**：修复了Web管理界面触发总结时导致的SQLite数据库锁定错误
  - 当Web管理界面需要发送报告时，使用活动的客户端实例而不是创建新实例
  - 避免了多个客户端实例同时访问同一个会话数据库文件
- **身份验证问题**：修复了Web管理界面创建新客户端实例时需要重新身份验证的问题
  - 通过线程间通信机制，让Web管理界面将任务加入队列，由主线程使用活动的客户端实例执行
  - 避免了创建新的客户端实例，从而避免了重新身份验证
- **事件循环冲突问题**：修复了Web管理界面和Telegram客户端之间的事件循环冲突
  - 确保Web管理界面和主Telegram客户端运行在各自的线程中，避免事件循环冲突
- **控制台闪退问题**：修复了Web管理界面触发总结时导致控制台闪退的问题
  - 在`send_report`函数中添加了全面的异常处理，捕获所有可能的错误
  - 即使发生错误，也返回空列表而不是让程序崩溃
- **客户端实例传递问题**：修复了`scheduler.py`中`main_job`函数没有正确传递客户端实例的问题
  - 修改`main_job`函数，让它从`telegram_client`模块获取活动的客户端实例
  - 将活动的客户端实例传递给`send_report`函数，避免创建新实例

### 改进
- **代码健壮性**：增强了`send_report`函数的错误处理能力，确保程序不会崩溃
- **性能优化**：通过使用活动的客户端实例，避免了不必要的客户端创建和身份验证
- **用户体验**：Web管理界面触发总结时提供更清晰的反馈信息
- **系统稳定性**：通过线程间通信机制，确保了Web管理界面和主程序的稳定运行

### 技术特性
- **线程安全队列**：使用Python的`queue.Queue`实现线程间通信
- **客户端实例复用**：通过`get_active_client()`函数获取和复用活动的客户端实例
- **全面的异常处理**：在关键函数中添加了try-catch块，防止未处理的异常导致程序崩溃
- **优雅的错误恢复**：即使发生错误，程序也能继续运行，不会影响其他功能

## [1.1.1] - 2026-01-09

### 修复
- **手动触发总结功能**：修复了Web管理界面中手动触发总结功能没有反应的问题
  - 修复了`send_long_message`函数调用时客户端实例为`None`的问题
  - 改为使用`send_report`函数，它会正确创建Telegram客户端实例
  - 确保总结报告能够正确发送给所有管理员
- **Web界面稳定性**：修复了Web服务器启动时的导入依赖问题
- **JavaScript计算错误**：修复了定时任务页面中下次执行时间计算的JavaScript语法错误

### 改进
- **错误处理**：增强了Web API端点的错误处理，提供更详细的错误信息
- **用户体验**：改进了Web界面的响应消息，提供更清晰的操作反馈
- **代码质量**：优化了Web应用代码结构，提高了可维护性

## [1.1.0] - 2026-01-09

### 新增
- **完整的Web管理界面**：为机器人添加了完整的Web管理界面
  - **仪表板** (`/`)：显示机器人状态、频道数量、系统健康状态、错误统计
  - **频道管理** (`/channels`)：查看、添加、删除频道，设置每个频道的自动总结时间
  - **配置管理** (`/config`)：查看和修改AI配置（API密钥、基础URL、模型）
  - **任务管理** (`/tasks`)：手动触发总结任务，查看定时任务列表，实时计算下次执行时间
  - **日志查看** (`/logs`)：查看系统日志，支持过滤、搜索和统计
  - **系统信息** (`/system`)：显示API凭证、管理员列表、错误统计详情
  - **登录系统**：会话管理，默认密码"Sakura"
- **完整的API端点系统**：
  - 系统管理API：清空错误统计、运行健康检查、运行系统诊断
  - 日志管理API：获取日志、清空日志（自动备份）
  - 功能API：手动触发总结、重启机器人、更新AI配置、频道时间配置管理
- **改进的重启功能**：
  - 实现了真正的自动重启功能，创建重启标记文件并执行重启脚本
  - 改进重启逻辑，只停止当前机器人的进程，不影响其他Python应用
  - 支持"web_admin"标识，重启后向所有管理员发送通知

### 改进
- **定时任务管理**：在任务管理页面添加实时下次执行时间计算功能
- **错误处理**：修复了HealthChecker方法调用错误，使用正确的`run_all_checks()`方法
- **模板系统**：修复了所有模板语法错误，确保所有页面都能正常访问
- **API端点**：添加了所有缺失的API端点，确保Web界面所有功能都能正常工作

### 技术特性
- **完整的导航系统**：7个功能页面，响应式设计
- **实际功能集成**：所有配置更改实时保存到`config.json`
- **认证系统**：会话管理，默认密码"Sakura"
- **重启功能**：精确停止当前进程，启动新进程，发送通知
- **API端点**：支持频道管理、配置更新、任务触发等操作
- **错误处理**：集成现有的错误处理系统
- **与Telegram命令兼容**：通过相同的`config.json`文件同步配置
- **实时时间计算**：定时任务页面实时计算并显示下次执行时间

## [1.0.3] - 2026-01-09

### 新增
- **/changelog 命令**：新增查看更新日志功能
  - 支持 `/changelog` 和 `/更新日志` 两种命令格式
  - 仅管理员可使用，读取并显示 CHANGELOG.md 文件内容
  - 自动处理长消息分割，支持完整的错误处理

### 改进
- **启动消息更新**：将 `/changelog (待实现)` 改为 `/changelog`
- **命令注册**：在机器人命令列表中添加 changelog 命令

## [1.0.2] - 2026-01-09

### 新增
- **错误处理与恢复机制增强**
  - 新增错误处理模块 (error_handler.py)
  - 智能重试机制，支持指数退避
  - 全局错误统计与记录系统
  - 健康检查系统，支持自定义检查
  - 优雅关闭处理，支持信号处理

### 改进
- **Telegram客户端增强**
  - 消息抓取函数添加重试机制
  - 错误隔离，单个频道失败不影响其他频道
  - 改进错误日志记录，包含更多上下文信息

- **AI客户端增强**
  - AI分析函数添加重试机制
  - 统一记录AI分析失败的错误信息
  - 记录AI分析的处理时间

- **系统稳定性提升**
  - 主程序集成错误处理系统
  - 自动注册默认健康检查
  - 设置优雅关闭信号处理程序

### 文档
- 新增错误处理改进文档 (ERROR_HANDLING_IMPROVEMENTS.md)
- 更新README.md中的版本信息和功能说明

## [1.0.1] - 2026-01-09

### 修复
- 修复 GitHub Actions 工作流权限问题
- 修复工作流语法错误
- 修复工作流触发条件
- 改进标签创建逻辑，处理已存在标签的情况
- Ciallo～(∠・ω< )⌒★

## [1.0.0] - 2026-01-07

### 新增
- 初始版本发布
- Telegram频道自动总结机器人核心功能
- 支持多频道管理
- 可配置的自动总结时间
- 自定义提示词功能
- AI配置管理
- 日志级别控制
- 重启功能
- 报告发送回源频道选项

### 技术特性
- 基于Telethon的Telegram机器人
- 使用APScheduler进行定时任务调度
- 支持DeepSeek等AI模型
- 配置文件管理
- Docker容器化支持

## 版本管理说明

### 版本号格式
本项目使用语义化版本控制（SemVer）：
- **主版本号**：不兼容的API修改
- **次版本号**：向下兼容的功能性新增
- **修订号**：向下兼容的问题修正

### 更新日志记录规范
1. 所有更改按类型分组：`新增`、`更改`、`修复`、`移除`
2. 每个版本包含发布日期
3. 重大更改需特别标注
4. 参考链接到相关PR或Issue

### 发布流程
1. 更新此CHANGELOG.md文件
2. 更新main.py中的版本号
3. 提交更改并创建Git tag
4. 推送tag触发GitHub自动发布

---
*此文件自动生成，请勿手动删除*
